<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>2&nbsp; Estimating the five fairness premiums â€“ A scalable toolbox for exposing indirect discrimination in insurance rates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./3_local.html" rel="next">
<link href="./1_simul_dataset.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-de0027c6417e353ce4980619e2136061.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});

</script>

<script type="text/x-mathjax-config">

	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {

	   MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';

		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';

		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';

		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';

		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';

		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';

		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';

		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';





		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';

		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';

		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';

		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';

		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';

	});

</script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>


<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="extras/style.css">
</head>

<body class="nav-sidebar floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">A scalable toolbox for exposing indirect discrimination in insurance rates</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/olicoside/Scalable_toolbox_online_supplement"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./2_training_spectrum.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimating the five fairness premiums</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_simul_dataset.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Example setup and simulations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_training_spectrum.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimating the five fairness premiums</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3_local.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Actuarial local metrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_dimensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Measuring the dimensions of fairness</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5_partitioning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Partitioning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6_integrated_framework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Integrated framework</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./9_references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-est_best" id="toc-sec-est_best" class="nav-link active" data-scroll-target="#sec-est_best"><span class="header-section-number">2.1</span> Best-estimate premium</a></li>
  <li><a href="#unaware-premium" id="toc-unaware-premium" class="nav-link" data-scroll-target="#unaware-premium"><span class="header-section-number">2.2</span> Unaware premium</a></li>
  <li><a href="#sec-est_aw" id="toc-sec-est_aw" class="nav-link" data-scroll-target="#sec-est_aw"><span class="header-section-number">2.3</span> Aware premium</a></li>
  <li><a href="#sec-est_corr" id="toc-sec-est_corr" class="nav-link" data-scroll-target="#sec-est_corr"><span class="header-section-number">2.4</span> Corrective premium</a></li>
  <li><a href="#hyperaware-premium" id="toc-hyperaware-premium" class="nav-link" data-scroll-target="#hyperaware-premium"><span class="header-section-number">2.5</span> Hyperaware premium</a></li>
  <li><a href="#visualization-the-estimated-spectrum" id="toc-visualization-the-estimated-spectrum" class="nav-link" data-scroll-target="#visualization-the-estimated-spectrum"><span class="header-section-number">2.6</span> Visualization the estimated spectrum</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">




<style>

#progress-bar {

  height: 4px;

  background: #004A8D;

  position: fixed;

  top: 0;

  left: 0;

  z-index: 9999;

  width: 0%;

  transition: width 0.2s ease-out;

}

</style>



<script>

document.addEventListener('scroll', () => {

  const scrollTop = window.scrollY || document.documentElement.scrollTop;

  const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;

  const progress = (scrollTop / docHeight) * 100;

  document.getElementById('progress-bar').style.width = progress + '%';

});

</script>



<div id="progress-bar"></div>



<div style="

  position: fixed;

  top: 450px;

  left: 0;

  padding: 0.75em 1em;

  background: #f3f4f6;

  border-right: 1px solid #dddddd;

  border-radius: 12px 0 0 12px;

  font-size: 0.90em;

  font-family: 'Helvetica Neue', sans-serif;

  box-shadow: 4px 4px 8px rgba(0,0,0,0.08);

  z-index: 1000;

  max-width: 260px;

">

  <a href="https://olicoside.github.io/" target="_blank" style="

    text-decoration: none;

    color: #004A8D;

    display: flex;

    align-items: center;

    font-weight: 500;

  ">

    <img src="img/logo_cas.png" alt="CAS Logo" style="max-width: 32px; margin-right: 0.4em;">

    Open main paper ðŸ”—

  </a>

</div>


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-training" class="quarto-section-identifier"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimating the five fairness premiums</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>Building on the simulations in <a href="#sec-simul-dataset" class="quarto-xref"><span class="quarto-unresolved-ref">sec-simul-dataset</span></a>, this section estimates the spectrum of fairness. It complements Section 4.3 of the <strong>main paper</strong>, linked from the supplementâ€™s introduction. We recommend keeping the main paper nearby, as this supplement focuses exclusively on implementation.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Packages for this section</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(latex2exp)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="do">## also setup python for optimal transport. </span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>get_python_env_path <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">file_path =</span> <span class="st">"python_env_path.txt"</span>) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"The file 'python_env_path.txt' is missing. Please create it and specify your Python environment path."</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the file and extract the first non-comment, non-empty line</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  env_path <span class="ot">&lt;-</span> <span class="fu">readLines</span>(file_path, <span class="at">warn =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  env_path <span class="ot">&lt;-</span> env_path[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"^#"</span>, env_path) <span class="sc">&amp;</span> <span class="fu">nzchar</span>(env_path)]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(env_path) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No valid Python environment path found in 'python_env_path.txt'. Please enter your path."</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">trimws</span>(env_path[<span class="dv">1</span>]))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>({</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  python_env_path <span class="ot">&lt;-</span> <span class="fu">get_python_env_path</span>()</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">use_python</span>(python_env_path, <span class="at">required =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Python environment successfully set to: "</span>, python_env_path)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(e<span class="sc">$</span>message)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Data for this section</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="st">'simuls/train_scenarios.json'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>valid <span class="ot">&lt;-</span>  <span class="fu">fromJSON</span>(<span class="st">'simuls/valid_scenarios.json'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="st">'simuls/test_scenarios.json'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="do">## For the experiment in section 5</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>sim_samples <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(<span class="st">'simuls/sim_study.json'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Functions and objects from past sections</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>levels_for_premiums <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mu_B"</span>, <span class="st">"mu_U"</span>, <span class="st">"mu_A"</span>, <span class="st">"mu_H"</span>, <span class="st">"mu_C"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>labels_for_premiums <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">widehat{</span><span class="sc">\\</span><span class="st">mu}^B$"</span>,<span class="st">"$</span><span class="sc">\\</span><span class="st">widehat{</span><span class="sc">\\</span><span class="st">mu}^U$"</span>, <span class="st">"$</span><span class="sc">\\</span><span class="st">widehat{</span><span class="sc">\\</span><span class="st">mu}^A$"</span>, <span class="st">"$</span><span class="sc">\\</span><span class="st">widehat{</span><span class="sc">\\</span><span class="st">mu}^H$"</span>, <span class="st">"$</span><span class="sc">\\</span><span class="st">widehat{</span><span class="sc">\\</span><span class="st">mu}^C$"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="do">## four ingredients for the 5 families of premiums</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>premium_generator <span class="ot">&lt;-</span> <span class="cf">function</span>(best, pdx, maps_to_corr, marg){</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">"mu_B"</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, d){</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="do">## simple call of the best estimate model</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">best</span>(<span class="fu">data.frame</span>(<span class="at">X1 =</span> x1,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X2 =</span> x2,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">D =</span> d))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  }, <span class="st">"mu_U"</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, <span class="at">d =</span> <span class="cn">NULL</span>){</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Explicit inference : mu_U = E(mu_B|X)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    tab_best <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="cf">function</span>(dl){</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">best</span>(<span class="fu">data.frame</span>(<span class="at">X1 =</span> x1,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X2 =</span> x2,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">D =</span> <span class="fu">rep</span>(dl, <span class="fu">length</span>(x1)))) </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      }) </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    tab_pdx <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="cf">function</span>(dl){</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pdx</span>(<span class="fu">data.frame</span>(<span class="at">X1 =</span> x1,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X2 =</span> x2,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">D =</span> <span class="fu">rep</span>(dl, <span class="fu">length</span>(x1))))</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    (tab_best <span class="sc">*</span> tab_pdx) <span class="sc">%&gt;%</span> <span class="fu">apply</span>(<span class="dv">1</span>, sum)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  }, <span class="st">"mu_A"</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, <span class="at">d =</span> <span class="cn">NULL</span>){</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="do">## mu_A = E(mu_B) unconditional</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="cf">function</span>(d){<span class="fu">best</span>(<span class="fu">data.frame</span>(<span class="at">X1 =</span> x1,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X2 =</span> x2,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>                    <span class="at">D =</span> <span class="fu">rep</span>(d, <span class="fu">length</span>(x1))))<span class="sc">*</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>       marg[d <span class="sc">+</span> <span class="dv">1</span>]}) <span class="sc">%&gt;%</span> <span class="fu">apply</span>(<span class="dv">1</span>, sum)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  }, <span class="st">"mu_H"</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, <span class="at">d =</span> <span class="cn">NULL</span>){</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="do">## explicit inference of mu_C : mu_H = E(mu_C|X)</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    tab_corr <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="cf">function</span>(dl){</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>      sb <span class="ot">&lt;-</span> <span class="fu">best</span>(<span class="fu">data.frame</span>(<span class="at">X1 =</span> x1,</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X2 =</span> x2,</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>                    <span class="at">D =</span> <span class="fu">rep</span>(dl, <span class="fu">length</span>(x1))))</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">maps_to_corr</span>(<span class="fu">data.frame</span>(<span class="at">mu_B =</span> sb, <span class="at">D =</span> dl))</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>      }) </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    tab_pdx <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="cf">function</span>(dl){</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pdx</span>(<span class="fu">data.frame</span>(<span class="at">X1 =</span> x1,</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X2 =</span> x2,</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>                    <span class="at">D =</span> <span class="fu">rep</span>(dl, <span class="fu">length</span>(x1))))</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    (tab_corr <span class="sc">*</span> tab_pdx) <span class="sc">%&gt;%</span> <span class="fu">apply</span>(<span class="dv">1</span>, sum)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  }, <span class="st">"mu_C"</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, <span class="at">d =</span> <span class="cn">NULL</span>){</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="do">## mu_C = T^{d}(mu_B(x, d))</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    mu_b <span class="ot">&lt;-</span> <span class="fu">best</span>(<span class="fu">data.frame</span>(<span class="at">X1 =</span> x1,</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>                    <span class="at">X2 =</span> x2,</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>                    <span class="at">D =</span> d))</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">maps_to_corr</span>(<span class="fu">data.frame</span>(<span class="at">mu_B =</span> mu_b, <span class="at">D =</span> d))</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>levels_for_quants <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'proxy_vuln'</span>, <span class="st">'risk_spread'</span>, <span class="st">'fair_range'</span>, <span class="st">'parity_cost'</span>)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>quant_generator <span class="ot">&lt;-</span> <span class="cf">function</span>(premiums){</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">'proxy_vuln'</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, d){</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    premiums<span class="sc">$</span><span class="fu">mu_U</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2) <span class="sc">-</span> </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>      premiums<span class="sc">$</span><span class="fu">mu_A</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2)</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">'risk_spread'</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, x3, d){</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    to_minmax <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">risk1 =</span> premiums<span class="sc">$</span><span class="fu">mu_B</span>(<span class="at">x1 =</span> x1,</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">x2 =</span> x2, </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">d =</span> <span class="dv">1</span>),</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>                            <span class="at">risk0 =</span> premiums<span class="sc">$</span><span class="fu">mu_B</span>(<span class="at">x1 =</span> x1,</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">x2 =</span> x2, </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">d =</span> <span class="dv">0</span>))</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(to_minmax, <span class="dv">1</span>, max) <span class="sc">-</span> <span class="fu">apply</span>(to_minmax, <span class="dv">1</span>, min) </span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>  <span class="st">'fair_range'</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, d){</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    to_minmax <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mu_b =</span> premiums<span class="sc">$</span><span class="fu">mu_B</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, </span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">d =</span> d),</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>                           <span class="at">mu_u =</span> premiums<span class="sc">$</span><span class="fu">mu_U</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">d =</span> <span class="cn">NULL</span>),</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>                           <span class="at">mu_a =</span> premiums<span class="sc">$</span><span class="fu">mu_A</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, </span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">d =</span> <span class="cn">NULL</span>),</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>                           <span class="at">mu_h =</span> premiums<span class="sc">$</span><span class="fu">mu_H</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2,</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">d =</span> <span class="cn">NULL</span>),</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>                           <span class="at">mu_c =</span> premiums<span class="sc">$</span><span class="fu">mu_C</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, </span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">d =</span> d))</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(to_minmax, <span class="dv">1</span>, max) <span class="sc">-</span> <span class="fu">apply</span>(to_minmax, <span class="dv">1</span>, min) </span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>  <span class="st">'parity_cost'</span> <span class="ot">=</span> <span class="cf">function</span>(x1, x2, d){</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    premiums<span class="sc">$</span><span class="fu">mu_C</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2,</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>              <span class="at">d =</span> d) <span class="sc">-</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>      premiums<span class="sc">$</span><span class="fu">mu_B</span>(<span class="at">x1 =</span> x1, <span class="at">x2 =</span> x2, </span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>                <span class="at">d =</span> d)</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>the_CAS_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'#FED35D'</span>, <span class="st">'#F89708'</span>, <span class="st">'#205ED5'</span>, <span class="st">'#142345'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In this section, we provide an example of detailed methodology for estimating the benchmarks premiums from the spectrum of fairness defined in Section 4.1 of the <strong>main paper</strong>. It complements the estimation of Section 4.1.</p>
<p>In this paper, premiums are estimated using <code>lightgbm</code> algorithms from <span class="citation" data-cites="Ke/al:2017">Ke et al. (<a href="#ref-Ke/al:2017" role="doc-biblioref">2017</a>)</span>, a package that supports common actuarial distributions (Tweedie, Poisson, Gamma, etc.) and was found to have excellent predictive performance compared to other boosting algorithm in <span class="citation" data-cites="Chevalier/al:2024">Chevalier and CÃ´tÃ© (<a href="#ref-Chevalier/al:2024" role="doc-biblioref">2024</a>)</span>. Given <code>lightgbm</code>â€™s flexibility, we advocate for careful variable preselection to:</p>
<ul>
<li>Ensure comprehensive coverage of risk factors,</li>
<li>Reduce redundancy and potential multicollinearity while preserving predictive value.</li>
</ul>
<p>We optimize hyperparameters with a validation set to prevent overfitting. Key hyperparameters in <code>lightgbm</code> are the number of trees (<code>num_iterations</code>), regularization (<code>lambda_l1</code>, <code>lambda_l2</code>) for complexity control, and subsampling percentages (<code>feature_fraction</code>, <code>bagging_fraction</code>) .</p>
<p>The data used to construct prices and the estimated spectrum should align to ensure comparability. In the Case Study of the <strong>main paper</strong>, we conduct a posteriori benchmarking, as the study period is historical. A posteriori assessment can reveal segments where the model misaligned from fairness pillars after the fact. In contrast, conducting benchmarking concurrently with the development of a new pricing model provides an estimate of how well the commercial price aligns with fairness pillars for future periods, though the true fairness implications of the commercial price will only become evident retrospectively.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Discretizing <span class="math inline">\(D\)</span>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Subsequent steps involve numerous computations over all possible values of <span class="math inline">\(D\)</span>. When <span class="math inline">\(D\)</span> is continuous, discretization can improve tractability. The discretized version should be used throughout this appendix, and the discretization function should be kept for future applications. For multivariate <span class="math inline">\(D\)</span>, one approach is to first discretize continuous components, then treat the vector as one categorical variable where each unique combination defines a category. Care should be taken to ensure a manageable number of categories, with sufficient representation in each.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Balancing benchmark premiums
</div>
</div>
<div class="callout-body-container callout-body">
<p>Profit and expense loadings are important, but they must not reintroduce unfairness. To align premium benchmarks with expected profits, we multiply the premiums by a factor <span class="math inline">\(\delta_j \geq 1~\forall j \in \{B, U, A, H, C\}\)</span> to globally balance all premiums to the level of the commercial price.</p>
</div>
</div>
<p>In what follows, we detail how we estimate each benchmark premium in our framework.</p>
<section id="sec-est_best" class="level2 page-columns page-full" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-est_best"><span class="header-section-number">2.1</span> Best-estimate premium</h2>
<p>The <strong>best estimate premium</strong> <span class="math inline">\(\widehat{\mu}^B(\mathbf{x}, d)\)</span> serves as the anchor. Thus, its estimation is crucial for our framework. It provides the best predictor of the response variable <span class="math inline">\(Y\)</span> when differentiating risks based on <span class="math inline">\((X, D)\)</span>. It can be derived from indicated rates or data-driven (what we do) estimates as detailed in Complement 5 of the <strong>main paper</strong>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="related-box">
<p><strong>Related section</strong><br>
The estimation strategy for the five families of fair premium is described in <strong>Section 4.3 of the main paper</strong>.</p>
</div>
</div></div><div class="cell">
<details class="code-fold">
<summary>Training the data-driven best-estimate price</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'___lgb_best_estimate.R'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">## clean the pred repo</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">unlink</span>(<span class="fu">file.path</span>(<span class="st">'preds'</span>, <span class="st">"*_best_estimate.json"</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define grid for hyperparameter optimization</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  hyperparameter_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">learning_rate =</span> <span class="fu">c</span>(<span class="fl">0.01</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature_fraction =</span> <span class="fu">c</span>(<span class="fl">0.75</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">bagging_fraction =</span> <span class="fu">c</span>(<span class="fl">0.75</span>),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">5</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_l1 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_l2 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>best_lgb <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(name){</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  list_df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'train'</span> <span class="ot">=</span> sims[[name]],</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'valid'</span> <span class="ot">=</span> valid[[name]],</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'test'</span> <span class="ot">=</span> test[[name]])</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">the_best_estimate_lightgbm_fun</span>(<span class="at">list_data =</span> list_df, </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">name =</span> name,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">hyperparameter_grid =</span> hyperparameter_grid)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Best for scenario:  Scenario1  
hyperparam  1 / 1 
Best valid mse: 52.00312  
optimal ntree: 499  
Training time: 16.40412  sec. 
Best for scenario:  Scenario2  
hyperparam  1 / 1 
Best valid mse: 52.68092  
optimal ntree: 540  
Training time: 16.64435  sec. 
Best for scenario:  Scenario3  
hyperparam  1 / 1 
Best valid mse: 52.57882  
optimal ntree: 528  
Training time: 16.15746  sec. </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Training the best-estimate price on experimental data (for later use in section 5)</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define grid for hyperparameter optimization</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>hyperparameter_grid_sims <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">learning_rate =</span> <span class="fu">c</span>(<span class="fl">0.01</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">bagging_fraction =</span> <span class="fu">c</span>(<span class="fl">0.75</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">6</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_l1 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_l2 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>best_sims <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(sim_samples), <span class="cf">function</span>(idx){</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    list_df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'train'</span> <span class="ot">=</span> sim_samples[[idx]]<span class="sc">$</span>train,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'valid'</span> <span class="ot">=</span> sim_samples[[idx]]<span class="sc">$</span>valid,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'test'</span> <span class="ot">=</span> sim_samples[[idx]]<span class="sc">$</span>test)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">the_best_estimate_lightgbm_fun</span>(<span class="at">list_data =</span> list_df,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">name =</span> <span class="fu">paste0</span>(<span class="st">'sim'</span>, idx),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">hyperparameter_grid =</span> hyperparameter_grid_sims)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="unaware-premium" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="unaware-premium"><span class="header-section-number">2.2</span> Unaware premium</h2>
<p>The <strong>unaware price</strong>, <span class="math inline">\(\mu^U(\mathbf{x})\)</span>, excludes direct use of <span class="math inline">\(D\)</span>. It is defined as the best predictor of <span class="math inline">\(\widehat{\mu}^B(\mathbf{X}, D)\)</span> given <span class="math inline">\(\mathbf{x}\)</span>:<br>
<span class="math display">\[\begin{equation*}  
    \widehat{\mu}^U(\mathbf{x}) = E\{\widehat{\mu}^B(\mathbf{x}, D) | X = \mathbf{x}\}.  
\end{equation*}\]</span><br>
This maintains consistency with the best estimate premium, whether <span class="math inline">\(\widehat{\mu}^B\)</span> is data-driven or based on indicated rates (Complement 5 of the <strong>main paper</strong>). One can use a to predict <span class="math inline">\(\widehat{\mu}^B(\mathbf{X}, D)\)</span> based on <span class="math inline">\(\mathbf{X}\)</span>. The loss function defaults to mean squared error as it is a reasonable distributional assumption for this response variable.</p>
<p>Alternatively (what we do), one can estimate the propensity and explicitly weight the best-estimate premiums based on predicted propensity. This also keeps consistency with the best-estimate.</p>
<div class="cell">
<details class="code-fold">
<summary>Estimating the propensity function</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'___lgb_pdx_estimate.R'</span>) </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="do">## clean the preds repo</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">unlink</span>(<span class="fu">file.path</span>(<span class="st">'preds'</span>, <span class="st">"*_pdx.json"</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  hyperparameter_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">learning_rate =</span> <span class="fu">c</span>(<span class="fl">0.01</span>),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature_fraction =</span> <span class="fu">c</span>(<span class="fl">0.75</span>),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">bagging_fraction =</span> <span class="fu">c</span>(<span class="fl">0.75</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">5</span>),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_l1 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_l2 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>pdx_lgb <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(name){</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  list_df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'train'</span> <span class="ot">=</span> sims[[name]],</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'valid'</span> <span class="ot">=</span> valid[[name]],</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'test'</span> <span class="ot">=</span> test[[name]])</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">the_pdx_lightgbm_fun</span>(<span class="at">list_data =</span> list_df, <span class="at">name =</span> name,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">hyperparameter_grid =</span> hyperparameter_grid)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Pdx for scenario:  Scenario1  
hyperparam  1 / 1 
Best valid binary logloss: 0.5763244  
optimal ntree: 428  
Training time: 16.00472  sec. 
Pdx for scenario:  Scenario2  
hyperparam  1 / 1 
Best valid binary logloss: 0.5845651  
optimal ntree: 371  
Training time: 13.72618  sec. 
Pdx for scenario:  Scenario3  
hyperparam  1 / 1 
Best valid binary logloss: 0.634273  
optimal ntree: 538  
Training time: 20.44827  sec. </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Training the propensity function on experimental data (for later use in section 5)</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define grid for hyperparameter optimization</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>hyperparameter_grid_sims <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">learning_rate =</span> <span class="fu">c</span>(<span class="fl">0.01</span>),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">bagging_fraction =</span> <span class="fu">c</span>(<span class="fl">0.75</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">6</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_l1 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda_l2 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>pdx_sims <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(sim_samples), <span class="cf">function</span>(idx){</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    list_df <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'train'</span> <span class="ot">=</span> sim_samples[[idx]]<span class="sc">$</span>train,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'valid'</span> <span class="ot">=</span> sim_samples[[idx]]<span class="sc">$</span>valid,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'test'</span> <span class="ot">=</span> sim_samples[[idx]]<span class="sc">$</span>test)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">the_pdx_lightgbm_fun</span>(<span class="at">list_data =</span> list_df, <span class="at">name =</span> <span class="fu">paste0</span>(<span class="st">'sim'</span>, idx),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">hyperparameter_grid =</span> hyperparameter_grid_sims)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sec-est_aw" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="sec-est_aw"><span class="header-section-number">2.3</span> Aware premium</h2>
<p>The <strong>aware premium</strong>, <span class="math inline">\(\widehat{\mu}^A(\mathbf{x})\)</span>, requires knowledge of the marginal distribution of <span class="math inline">\(D\)</span>. The aware price, a particular case of the ``discrimination-freeâ€™â€™ price of <span class="citation" data-cites="Lindholm/al:2022">Lindholm et al. (<a href="#ref-Lindholm/al:2022" role="doc-biblioref">2022</a>)</span>, is computed as:<br>
<span class="math display">\[\begin{equation*}
    \widehat{\mu}^A(\mathbf{x}) = \sum_{d\in \mathcal{D}} \widehat{\mu}^B(\mathbf{x}, d) \widehat{\Pr}(D = d).
\end{equation*}\]</span> As discussed earlier, we assume <span class="math inline">\(D\)</span> is discrete or discretized. If the training sample is representative of the target population (portfolio, market, or region?), empirical proportions are consistent estimators of <span class="math inline">\(\widehat{\Pr}(D = d)\)</span>. This is also an estimator suggested in Section 5 of <span class="citation" data-cites="Lindholm/al:2022">Lindholm et al. (<a href="#ref-Lindholm/al:2022" role="doc-biblioref">2022</a>)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Computing the empirical proportions for protected supopulations</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>marg_dist <span class="ot">&lt;-</span> sims <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(data){</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>D <span class="sc">%&gt;%</span> table <span class="sc">%&gt;%</span>  prop.table</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="do">## for later use</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(marg_dist, <span class="st">'preds/the_empirical_proportions.rds'</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Computing the empirical proportions for protected supopulations on experimental data (for later use in section 5)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>marg_dist_sims <span class="ot">&lt;-</span> <span class="fu">seq_along</span>(sim_samples) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(idx){</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  sim_samples[[idx]]<span class="sc">$</span>train<span class="sc">$</span>D <span class="sc">%&gt;%</span> table <span class="sc">%&gt;%</span>  prop.table</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This method generalizes the use of <span class="math inline">\(D\)</span> as a control variable to prevent distortions in estimated effect of <span class="math inline">\(\mathbf{X}\)</span> due to omitted variable bias. It applies to all model types and has a causal interpretation under the assumptions that: (i) possible values of <span class="math inline">\(\mathbf{X}\)</span> are observed across all groups of <span class="math inline">\(D\)</span> (no extrapolation), (ii) <span class="math inline">\(D\)</span> causes both <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(Y\)</span>, and (iii) there are no relevant unobserved variables. Under the same assumptions, other methods are estimators of the aware premium. One example is inverse probability weighting, which re-weights observations to (artificially) remove the association between <span class="math inline">\(\mathbf{X}\)</span> and <span class="math inline">\(D\)</span>, preventing proxy effects.</p>
</div>
</div>
</section>
<section id="sec-est_corr" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="sec-est_corr"><span class="header-section-number">2.4</span> Corrective premium</h2>
<p>We estimate the <strong>corrective premium</strong>, <span class="math inline">\(\widehat{\mu}^C(\mathbf{x}, d)\)</span>, designed to enforce strong demographic parity by aligning premium distributions across protected groups. Various methods can achieve this, but we recommend the optimal transport approach of <span class="citation" data-cites="Hu/al:2024">Hu, Ratz, and Charpentier (<a href="#ref-Hu/al:2024" role="doc-biblioref">2024</a>)</span>. Its advantage lies in modifying <span class="math inline">\(\widehat{\mu^B}(\mathbf{x}, d)\)</span> while keeping the overall spectrum estimation anchored to the initial best-estimate premium. As an incremental adjustment, it minimizes modeling complexity while enforcing demographic parity, yielding a simple estimator for the corrective premium.</p>
<p>The corrective premium is computed by training a <em>transport function</em> that shifts best-estimate premiums for each protected group toward a common <em>barycenter</em>, ensuring demographic parity through corrective direct discrimination. See <span class="citation" data-cites="Hu/al:2024">Hu, Ratz, and Charpentier (<a href="#ref-Hu/al:2024" role="doc-biblioref">2024</a>)</span> for details. This optimal transport method is implemented in Python via the <a href="https://equilibration.github.io/equipy/"><code>Equipy</code></a> package of <span class="citation" data-cites="Machado/al:2025">Fernandes Machado et al. (<a href="#ref-Machado/al:2025" role="doc-biblioref">2025</a>)</span>. The following chunk illustrates how this method, despite its complexity, translates into concise Python code.</p>
<div id="lst-fair_wasserstein" class="code-example listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-fair_wasserstein-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;2.1: Illustrative Python code for wasserstein transport toward corrective premiums.
</figcaption>
<div aria-describedby="lst-fair_wasserstein-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> equipy.fairness <span class="im">import</span> FairWasserstein</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load best-estimate premiums and associated sensitive attributes</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>best_est_train <span class="op">=</span> pd.read_csv(<span class="st">'best_est_prem_train.csv'</span>)  <span class="co"># Training premiums</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>sens_train <span class="op">=</span> pd.read_csv(<span class="st">'sensitive_train.csv'</span>)  <span class="co"># discrete sensitive data</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Train Fair Wasserstein transport to adjust premiums</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>barycenter <span class="op">=</span> FairWasserstein()</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>barycenter.fit(best_est.values, sens.values)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load best-estimate premiums and associated sensitive attributes</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>best_est_test <span class="op">=</span> pd.read_csv(<span class="st">'best_est_prem_test.csv'</span>)  <span class="co"># Training premiums</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>sens_test <span class="op">=</span> pd.read_csv(<span class="st">'sensitive_test.csv'</span>)  <span class="co"># discrete sensitive data</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply transformation to obtain fairness-adjusted premiums</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>corrective_premiums_test <span class="op">=</span> barycenter.transform(best_est_test.values, sens_test.values)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Save results</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(corrective_premiums).to_csv(<span class="st">'corr_prem_test.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Optimal transport and wasserstein distance : technical details
</div>
</div>
<div class="callout-body-container callout-body">
<p>ICI ARTHUR?</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Computing the optimal transport mapping for the scenarios</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source_python</span>(<span class="st">"___opt_transp.py"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="do">## now, the folder 'transported' exist, with one epsilon_y file per scenario</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To predict corrective premium on other datasets, one can alternatively train a <code>lightgbm</code> model of mapping from <span class="math inline">\((X, D)\)</span> to the resulting corrective premiums from <code>Equipy</code> on the training sample.</p>
<div class="cell">
<details class="code-fold">
<summary>Computing the optimal transport mapping for the scenarios</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'___lgb_mapping_to_corr.R'</span>) </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>corr_mapping_lgb <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims)) <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(the_mapping_to_corr_lightgbm_fun)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mapping to corr. for scenario:  Scenario1  
Data import: 0.878427  sec. 
Data conversion: 0.01414204  sec. 
Lgb training : 27.78518  sec. 
Mapping to corr. for scenario:  Scenario2  
Data import: 0.3069272  sec. 
Data conversion: 0.01718998  sec. 
Lgb training : 28.46357  sec. 
Mapping to corr. for scenario:  Scenario3  
Data import: 0.258337  sec. 
Data conversion: 0.009591818  sec. 
Lgb training : 12.91655  sec. </code></pre>
</div>
</div>
</section>
<section id="hyperaware-premium" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="hyperaware-premium"><span class="header-section-number">2.5</span> Hyperaware premium</h2>
<p>The <strong>hyperaware premium</strong>, <span class="math inline">\(\widehat{\mu}^H(\mathbf{x})\)</span>, is the best non-directly discriminatory approximation of the corrective premium. We construct a <code>lightgbm</code> using only <span class="math inline">\(\mathbf{X}\)</span> to predict the corrective premium, aiming at demographic parity without direct reliance on <span class="math inline">\(D\)</span>:<br>
<span class="math display">\[\begin{equation*}
    \widehat{\mu}^H(\mathbf{x}) = E\{\widehat{\mu}^C(\mathbf{x}, D) | X = \mathbf{x}\}.
\end{equation*}\]</span><br>
Since the response variable is a premium, MSE is a correct choice of loss function in most cases. Just as for the unaware premium, one can explicitly aggregate corrective premiums across protected groups using estimated propensities as weights. This is what we do here.</p>
</section>
<section id="visualization-the-estimated-spectrum" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="visualization-the-estimated-spectrum"><span class="header-section-number">2.6</span> Visualization the estimated spectrum</h2>
<p>By combining all the trained models as component into a trained spectrum of fairness, we can define the premium function that will serve to predict the premiums</p>
<div class="cell">
<details class="code-fold">
<summary>Defining the estimated premium and metrics functions</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>premiums <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(name){</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">premium_generator</span>(<span class="at">best =</span> best_lgb[[name]]<span class="sc">$</span>pred_fun, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pdx =</span> pdx_lgb[[name]]<span class="sc">$</span>pred_fun, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">maps_to_corr =</span> corr_mapping_lgb[[name]], </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">marg =</span> marg_dist[[name]])</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>quants <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(name){</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quant_generator</span>(<span class="at">premiums =</span> premiums[[name]])</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="do">## For experimental data (future use in section 5)</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>premiums_sims <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">obj =</span> <span class="fu">seq_along</span>(sim_samples),</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nm =</span> <span class="fu">names</span>(sim_samples)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(idx){</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">premium_generator</span>(<span class="at">best =</span> best_sims[[idx]]<span class="sc">$</span>pred_fun, </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pdx =</span> pdx_sims[[idx]]<span class="sc">$</span>pred_fun, </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">maps_to_corr =</span> corr_mapping_lgb[[<span class="st">'Scenario1'</span>]], <span class="do">## We put anything, won't be used anyway as we focus on proxy vulnerabiltiy for section 5. </span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">marg =</span> marg_dist_sims[[idx]])</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>quants_sims <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">obj =</span> <span class="fu">seq_along</span>(sim_samples),</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nm =</span> <span class="fu">names</span>(sim_samples)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(idx){</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quant_generator</span>(<span class="at">premiums =</span> premiums_sims[[idx]])</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Computation of estimated premiums and local metrics across the grid</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_to_g_file <span class="ot">&lt;-</span> <span class="st">"preds/df_to_g.json"</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the JSON file exists</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(df_to_g_file)) {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] File exists. Reading df_to_g from %s"</span>, <span class="fu">Sys.time</span>(), df_to_g_file))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  df_to_g <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(df_to_g_file)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="do">## From the first section of the online supplement</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>preds_grid_stats_theo <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="st">'preds/preds_grid_stats_theo.json'</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>df_to_g <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(name) {</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Processing: %s"</span>, <span class="fu">Sys.time</span>(), name))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  local_scenario_df <span class="ot">&lt;-</span> preds_grid_stats_theo[[name]]</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start time for this scenario</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Compute premiums</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 1: Computing premiums"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  premium_results <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> levels_for_premiums) <span class="sc">%&gt;%</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(s) {</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Computing premium: %s"</span>, <span class="fu">Sys.time</span>(), s))</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>      premiums[[name]][[s]](</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">x1 =</span> local_scenario_df<span class="sc">$</span>x1,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">x2 =</span> local_scenario_df<span class="sc">$</span>x2,</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">d =</span> local_scenario_df<span class="sc">$</span>d</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Compute PDX</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 2: Computing PDX"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  pdx_results <span class="ot">&lt;-</span> pdx_lgb[[name]]<span class="sc">$</span><span class="fu">pred_fun</span>(</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">X1 =</span> local_scenario_df<span class="sc">$</span>x1,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">X2 =</span> local_scenario_df<span class="sc">$</span>x2,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">D =</span> local_scenario_df<span class="sc">$</span>d</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine results</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 5: Combining results"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    local_scenario_df,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    premium_results,</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">pdx =</span> pdx_results</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Log completion time</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>  end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Finished processing: %s (Duration: %.2f seconds)"</span>, end_time, name, <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(end_time, start_time, <span class="at">units =</span> <span class="st">"secs"</span>))))</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the entire df_to_g object to JSON</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Saving df_to_g to %s"</span>, <span class="fu">Sys.time</span>(), df_to_g_file))</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toJSON</span>(df_to_g, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">write</span>(df_to_g_file)</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(df_to_g_theo)</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>grid_stats_path <span class="ot">&lt;-</span> <span class="st">'preds/preds_grid_stats.json'</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Check and load or compute preds_grid_stats</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(grid_stats_path)) {</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>  preds_grid_stats <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(grid_stats_path)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>  preds_grid_stats <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(df_to_g)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(<span class="cf">function</span>(name) {</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(df_to_g[[name]], </span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">setNames</span>(<span class="at">nm =</span> levels_for_quants) <span class="sc">%&gt;%</span> </span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">sapply</span>(<span class="cf">function</span>(s) {</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>                         quants[[name]][[s]](<span class="at">x1 =</span> df_to_g[[name]]<span class="sc">$</span>x1,</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">x2 =</span> df_to_g[[name]]<span class="sc">$</span>x2,</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">d =</span> df_to_g[[name]]<span class="sc">$</span>d)</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>                       }))</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toJSON</span>(preds_grid_stats, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write</span>(grid_stats_path)</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Computing estimated premiums and local metrics for the simulations</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pop_to_g_file <span class="ot">&lt;-</span> <span class="st">"preds/pop_to_g.json"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the JSON file exists</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(pop_to_g_file)) {</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] File exists. Reading pop_to_g from %s"</span>, <span class="fu">Sys.time</span>(), pop_to_g_file))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  pop_to_g <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(pop_to_g_file)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="do">## From the first section of the online supplement</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>preds_pop_stats_theo <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="st">'preds/preds_pop_stats_theo.json'</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>pop_to_g <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(name) {</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Processing: %s"</span>, <span class="fu">Sys.time</span>(), name))</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start time for this simulation</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  list_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'train'</span> <span class="ot">=</span> sims[[name]],</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'valid'</span> <span class="ot">=</span> valid[[name]],</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'test'</span> <span class="ot">=</span> test[[name]])</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(list_data)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(nm){</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> list_data[[nm]]</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Compute premiums</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 1: Computing premiums"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  premium_results <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> levels_for_premiums) <span class="sc">%&gt;%</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(s) {</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Computing premium: %s"</span>, <span class="fu">Sys.time</span>(), s))</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>      premiums[[name]][[s]](</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">x1 =</span> data<span class="sc">$</span>X1,</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">x2 =</span> data<span class="sc">$</span>X2,</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">d =</span> data<span class="sc">$</span>D</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Compute PDX</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 2: Computing PDX"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  pdx_results <span class="ot">&lt;-</span> pdx_lgb[[name]]<span class="sc">$</span><span class="fu">pred_fun</span>(</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">X1 =</span> data<span class="sc">$</span>X1,</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">X2 =</span> data<span class="sc">$</span>X2,</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">D =</span> data<span class="sc">$</span>D</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine results</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 5: Combining results"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    preds_pop_stats_theo[[name]][[nm]],</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    premium_results,</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">pdx =</span> pdx_results</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>  }) </span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Log completion time</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>  end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Finished processing: %s (Duration: %.2f seconds)"</span>, end_time, name, <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(end_time, start_time, <span class="at">units =</span> <span class="st">"secs"</span>))))</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the entire df_to_g object to JSON</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Saving pop_to_g to %s"</span>, <span class="fu">Sys.time</span>(), pop_to_g_file))</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toJSON</span>(pop_to_g, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">write</span>(pop_to_g_file)</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(pop_to_g_theo)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>pop_stats_path <span class="ot">&lt;-</span> <span class="st">'preds/preds_pop_stats.json'</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Check and load or compute preds_pop_stats</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(pop_stats_path)) {</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>  preds_pop_stats <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(pop_stats_path)</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>  preds_pop_stats <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(<span class="cf">function</span>(name) {</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(pop_to_g[[name]])) <span class="sc">%&gt;%</span>  </span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(<span class="cf">function</span>(set) {</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>          local_df <span class="ot">&lt;-</span> pop_to_g[[name]][[set]]</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>          <span class="fu">data.frame</span>(local_df, </span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">setNames</span>(<span class="at">nm =</span> levels_for_quants) <span class="sc">%&gt;%</span> </span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">sapply</span>(<span class="cf">function</span>(s) {</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>                         quants[[name]][[s]](<span class="at">x1 =</span> local_df<span class="sc">$</span>X1,</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">x2 =</span> local_df<span class="sc">$</span>X2,</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">d =</span>  local_df<span class="sc">$</span>D)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>                       }))</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toJSON</span>(preds_pop_stats, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write</span>(pop_stats_path)</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Computing estimated premiums and local metrics for the experiment</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>sims_to_g_file <span class="ot">&lt;-</span> <span class="st">"preds/sims_to_g.json"</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the JSON file exists</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(sims_to_g_file)) {</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] File exists. Reading sims_to_g from %s"</span>, <span class="fu">Sys.time</span>(), sims_to_g_file))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  sims_to_g <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(sims_to_g_file)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="do">## From the first section of the online supplement</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>preds_sims_stats_theo <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="st">'preds/preds_sims_stats_theo.json'</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>sims_to_g <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">object =</span> <span class="fu">seq_along</span>(sim_samples), </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nm =</span> <span class="fu">names</span>(sim_samples)) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(idx) {</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Processing: %s"</span>, <span class="fu">Sys.time</span>(), <span class="fu">paste0</span>(idx, <span class="st">'/'</span>, <span class="fu">length</span>(sim_samples))))</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  samples_to_ret <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sim_samples[[idx]])) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(nm){</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> preds_sims_stats_theo[[idx]][[nm]]</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Compute premiums</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 1: Computing premiums"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  premium_results <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> levels_for_premiums) <span class="sc">%&gt;%</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="cf">function</span>(s) {</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Computing premium: %s"</span>, <span class="fu">Sys.time</span>(), s))</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>      premiums_sims[[idx]][[s]](</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">x1 =</span> data<span class="sc">$</span>X1,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">x2 =</span> data<span class="sc">$</span>X2,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">d =</span> data<span class="sc">$</span>D</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Compute PDX</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 2: Computing PDX"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  pdx_results <span class="ot">&lt;-</span> pdx_sims[[idx]]<span class="sc">$</span><span class="fu">pred_fun</span>(</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">X1 =</span> data<span class="sc">$</span>X1,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">X2 =</span> data<span class="sc">$</span>X2,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">D =</span> data<span class="sc">$</span>D</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine results</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Step 5: Combining results"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    premium_results,</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">pdx =</span> pdx_results</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(samples_to_ret)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the entire df_to_g object to JSON</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"[%s] Saving sims_to_g to %s"</span>, <span class="fu">Sys.time</span>(), sims_to_g_file))</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toJSON</span>(sims_to_g, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">write</span>(sims_to_g_file)</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>sims_stats_path <span class="ot">&lt;-</span> <span class="st">'preds/preds_sims_stats.json'</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Check and load or compute preds_pop_stats</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(sims_stats_path)) {</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>  preds_sims_stats <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(sims_stats_path)</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>  preds_sims_stats <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims_to_g)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(<span class="cf">function</span>(name) {</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">names</span>(sims_to_g[[name]])) <span class="sc">%&gt;%</span>  </span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(<span class="cf">function</span>(set) {</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>          local_df <span class="ot">&lt;-</span> sims_to_g[[name]][[set]]</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>          <span class="fu">data.frame</span>(local_df, </span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">setNames</span>(<span class="at">nm =</span> levels_for_quants) <span class="sc">%&gt;%</span> </span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">sapply</span>(<span class="cf">function</span>(s) {</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>                         quants_sims[[name]][[s]](<span class="at">x1 =</span> local_df<span class="sc">$</span>X1,</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">x2 =</span> local_df<span class="sc">$</span>X2,</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">d =</span>  local_df<span class="sc">$</span>D)</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>                       }))</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toJSON</span>(preds_sims_stats, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write</span>(sims_stats_path)</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>R code producing the estimated propensity illustration across scenarios</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>to_save_pdx_perpop <span class="ot">&lt;-</span> <span class="fu">names</span>(df_to_g) <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(name){</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    cols <span class="ot">&lt;-</span> the_CAS_colors</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    pop_id <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(df_to_g) <span class="sc">==</span> name)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="do">## keep only axis for last plot</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(pop_id <span class="sc">==</span> <span class="dv">1</span>){ <span class="co"># If it's the last, apply correct xlabels</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>      the_y_scale <span class="ot">&lt;-</span> <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>      the_y_label <span class="ot">&lt;-</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">widehat{P}(D = 1|x_1, x_2)$"</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> { <span class="co"># otherwise, remove everything</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>      the_y_scale <span class="ot">&lt;-</span> <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="cn">NULL</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>      the_y_label <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    the_pops <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Scenario 1'</span>, <span class="st">'Scenario 2'</span>, <span class="st">'Scenario 3'</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="do">## lets graph</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    df_to_g[[name]] <span class="sc">%&gt;%</span> </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">the_population =</span> name) <span class="sc">%&gt;%</span> </span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(x1 <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">9</span>, x1 <span class="sc">&lt;=</span> <span class="dv">11</span>,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>         d <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(x1, x2) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">pdx =</span> <span class="fu">mean</span>(pdx)) <span class="sc">%&gt;%</span>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> pdx,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>             <span class="at">lty =</span> <span class="fu">factor</span>(x2),</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="fu">factor</span>(x2),</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="fu">factor</span>(x2),</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fu">factor</span>(x2),</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">factor</span>(x2))) <span class="sc">+</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">'solid'</span>, <span class="st">'31'</span>, <span class="st">'21'</span>, <span class="st">'11'</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$x_2$'</span>)) <span class="sc">+</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> cols, <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$x_2$'</span>)) <span class="sc">+</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linewidth_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="fl">0.85</span>, <span class="fl">0.55</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$x_2$'</span>)) <span class="sc">+</span>  </span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.65</span>, <span class="fl">0.75</span>, <span class="fl">0.85</span>, <span class="fl">0.9</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$x_2$'</span>)) <span class="sc">+</span> </span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$x_1$"</span>),</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> the_y_label,</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(the_pops[pop_id])) <span class="sc">+</span> </span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>)<span class="sc">*</span><span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span>)  <span class="sc">+</span> <span class="co"># see above</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  the_y_scale <span class="sc">+</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> .,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>                           <span class="at">nrow =</span> <span class="dv">1</span>,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                           <span class="at">widths =</span> <span class="dv">15</span>, <span class="at">heights =</span> <span class="dv">1</span>,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>                           <span class="at">common.legend =</span> T,</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>                           <span class="at">legend =</span> <span class="st">'right'</span>)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">'figs'</span>)) <span class="fu">dir.create</span>(<span class="st">'figs'</span>)</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename =</span> <span class="st">"figs/graph_pdx_perpop.png"</span>,</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>       <span class="at">plot =</span> to_save_pdx_perpop,</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>       <span class="at">height =</span> <span class="fl">3.25</span>,</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="fl">7.55</span>,</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">"in"</span>,</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>       <span class="at">device =</span> <span class="st">"png"</span>, <span class="at">dpi =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fig-prop_t" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-prop_t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.1: Estimated propensity in terms of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> for simulations
</figcaption>
<div aria-describedby="fig-prop_t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figs/graph_pdx_perpop.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;2.1: Estimated propensity in terms of x_1 and x_2 for simulations"><img src="figs/graph_pdx_perpop.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
</figure>
</div>
<div class="cell">
<details class="code-fold">
<summary>R code producing the estimated best-estimate, unaware, and aware illustration.</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>to_save_premiumsdense_BUA_perpop <span class="ot">&lt;-</span> <span class="fu">names</span>(df_to_g) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(pop_name){</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## the colors</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    cols <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">5</span>, <span class="st">'Spectral'</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="sc">%&gt;%</span>  colorspace<span class="sc">::</span><span class="fu">darken</span>(<span class="fl">0.25</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># the_CAS_colors_full[c(6, 5, 2)]</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  pop_id <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(df_to_g) <span class="sc">==</span> pop_name)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## keep only axis for last plot</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(pop_name <span class="sc">==</span> <span class="fu">head</span>(<span class="fu">names</span>(df_to_g), <span class="dv">1</span>)){ <span class="co"># If it's the last, apply correct xlabels</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      the_y_scale <span class="ot">&lt;-</span> <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">110</span>, <span class="dv">130</span>),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span>dollar,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">140</span>))</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      the_y_label <span class="ot">&lt;-</span> </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">widehat{</span><span class="sc">\\</span><span class="st">mu}(x_1, x_2, d)$"</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> { <span class="co"># otherwise, remove everything</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      the_y_scale <span class="ot">&lt;-</span> <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">110</span>, <span class="dv">130</span>),</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="cn">NULL</span>,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">140</span>))</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>      the_y_label <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  to_illustrate <span class="ot">&lt;-</span> df_to_g[[pop_name]] <span class="sc">%&gt;%</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  reshape2<span class="sc">::</span><span class="fu">melt</span>(<span class="at">measure.vars =</span> <span class="fu">paste0</span>(levels_for_premiums[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="fu">factor</span>(variable,</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>                             <span class="at">levels =</span> <span class="fu">paste0</span>(levels_for_premiums[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]),</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>                             <span class="at">labels =</span> labels_for_premiums[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(x1 <span class="sc">&lt;=</span> <span class="dv">10</span>, x1 <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">8</span>) </span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  to_illustrate<span class="sc">$</span>value[to_illustrate<span class="sc">$</span>pdx <span class="sc">&lt;</span> <span class="fl">0.1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>  to_illustrate <span class="sc">%&gt;%</span> </span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> value,</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>             <span class="at">lty =</span> <span class="fu">factor</span>(d),</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="fu">factor</span>(x2),</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="fu">factor</span>(x2),</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fu">factor</span>(d),</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">factor</span>(variable))) <span class="sc">+</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">'solid'</span>, <span class="st">'32'</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$d$'</span>)) <span class="sc">+</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> cols, <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$</span><span class="sc">\\</span><span class="st">mu$'</span>), <span class="at">labels =</span> latex2exp<span class="sc">::</span>TeX) <span class="sc">+</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linewidth_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="dv">1</span>, <span class="fl">0.85</span>, <span class="fl">0.55</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$x_2$'</span>)) <span class="sc">+</span>  </span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.35</span>, <span class="fl">0.7</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$d$'</span>)) <span class="sc">+</span> </span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$x_1$"</span>), <span class="at">y =</span> the_y_label,</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">'Scenario '</span>, pop_id)) <span class="sc">+</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>( <span class="sc">-</span><span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">6</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>  the_y_scale <span class="sc">+</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> .,</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncol =</span> <span class="dv">3</span>,</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>                           <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">15</span>, <span class="dv">15</span>), <span class="at">heights =</span> <span class="dv">1</span>,</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>                           <span class="at">common.legend =</span> T,</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>                           <span class="at">legend =</span> <span class="st">'right'</span>)</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename =</span> <span class="st">"figs/graph_premiumsdense_BUA_perpop.png"</span>,</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>       <span class="at">plot =</span> to_save_premiumsdense_BUA_perpop,</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">4</span>,</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="fl">10.55</span>,</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">"in"</span>,</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">device =</span> <span class="st">"png"</span>, <span class="at">dpi =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fig-est_premiums_BUA" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-est_premiums_BUA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.2: Estimated best-estimate <span class="math inline">\(\widehat{\mu}^B\)</span>, unaware <span class="math inline">\(\widehat{\mu}^U\)</span>, and aware <span class="math inline">\(\widehat{\mu}^A\)</span> premiums for scenarios 1, 2, and 3 in the Example as a function of <span class="math inline">\(x_1\)</span>, <span class="math inline">\(x_2\)</span>, and <span class="math inline">\(d\)</span>.
</figcaption>
<div aria-describedby="fig-est_premiums_BUA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figs/graph_premiumsdense_BUA_perpop.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2.2: Estimated best-estimate \widehat{\mu}^B, unaware \widehat{\mu}^U, and aware \widehat{\mu}^A premiums for scenarios 1, 2, and 3 in the Example as a function of x_1, x_2, and d."><img src="figs/graph_premiumsdense_BUA_perpop.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
</figure>
</div>
<div class="cell">
<details class="code-fold">
<summary>R code producing the estimated aware, hyperaware, corrective illustration.</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>to_save_premiumsdense_AHC_perpop <span class="ot">&lt;-</span> <span class="fu">names</span>(df_to_g) <span class="sc">%&gt;%</span> <span class="fu">lapply</span>(<span class="cf">function</span>(pop_name){</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## the colors</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    cols <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="dv">5</span>, <span class="st">'Spectral'</span>)[<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>] <span class="sc">%&gt;%</span>  colorspace<span class="sc">::</span><span class="fu">darken</span>(<span class="fl">0.25</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  pop_id <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(df_to_g) <span class="sc">==</span> pop_name)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## keep only axis for last plot</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(pop_name <span class="sc">==</span> <span class="fu">head</span>(<span class="fu">names</span>(df_to_g), <span class="dv">1</span>)){ <span class="co"># If it's the last, apply correct xlabels</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>      the_y_scale <span class="ot">&lt;-</span> <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">110</span>, <span class="dv">130</span>),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span>dollar,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">130</span>))</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      the_y_label <span class="ot">&lt;-</span> </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">widehat{</span><span class="sc">\\</span><span class="st">mu}(x_1, x_2, d)$"</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> { <span class="co"># otherwise, remove everything</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>      the_y_scale <span class="ot">&lt;-</span> <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">110</span>, <span class="dv">130</span>),</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="cn">NULL</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">130</span>))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>      the_y_label <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  to_illustrate <span class="ot">&lt;-</span> df_to_g[[pop_name]] <span class="sc">%&gt;%</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  reshape2<span class="sc">::</span><span class="fu">melt</span>(<span class="at">measure.vars =</span> <span class="fu">paste0</span>(levels_for_premiums[<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="fu">factor</span>(variable,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>                             <span class="at">levels =</span> <span class="fu">paste0</span>(levels_for_premiums[<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>]),</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                             <span class="at">labels =</span> labels_for_premiums[<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(x1 <span class="sc">&lt;=</span> <span class="dv">10</span>, x1 <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">8</span>) </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># group_by(x1, d, variable) %&gt;% summarise(value = mean(value)) %&gt;%  ungroup %&gt;% </span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="do">## mask part of the line </span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  to_illustrate<span class="sc">$</span>value[to_illustrate<span class="sc">$</span>pdx <span class="sc">&lt;</span> <span class="fl">0.1</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  to_illustrate <span class="sc">%&gt;%</span> </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> value,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>             <span class="at">lty =</span> <span class="fu">factor</span>(d),</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>             <span class="at">linewidth =</span> <span class="fu">factor</span>(x2),</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>             <span class="at">shape =</span> <span class="fu">factor</span>(x2),</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fu">factor</span>(d),</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">factor</span>(variable))) <span class="sc">+</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">'solid'</span>, <span class="st">'32'</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$d$'</span>)) <span class="sc">+</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> cols, <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$</span><span class="sc">\\</span><span class="st">mu$'</span>), <span class="at">labels =</span> latex2exp<span class="sc">::</span>TeX) <span class="sc">+</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linewidth_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="dv">1</span>, <span class="fl">0.85</span>, <span class="fl">0.55</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$x_2$'</span>)) <span class="sc">+</span>  </span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="fl">0.35</span>, <span class="fl">0.7</span>), <span class="at">name =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'$d$'</span>)) <span class="sc">+</span> </span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"$x_1$"</span>), <span class="at">y =</span> the_y_label,</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">'Scenario '</span>, pop_id)) <span class="sc">+</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>( <span class="sc">-</span><span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">6</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  the_y_scale <span class="sc">+</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> .,</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncol =</span> <span class="dv">3</span>,</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>                           <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">15</span>, <span class="dv">15</span>),</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>                            <span class="at">heights =</span> <span class="dv">1</span>,</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>                           <span class="at">common.legend =</span> T,</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>                           <span class="at">legend =</span> <span class="st">'right'</span>)</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename =</span> <span class="st">"figs/graph_premiumsdense_AHC_perpop.png"</span>,</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>       <span class="at">plot =</span> to_save_premiumsdense_AHC_perpop,</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">4</span>,</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="fl">10.55</span>,</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">"in"</span>,</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>       <span class="at">device =</span> <span class="st">"png"</span>, <span class="at">dpi =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fig-est_premiums_AHC" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-est_premiums_AHC-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2.3: Estimated aware <span class="math inline">\(\widehat{\mu}^A\)</span>, hyperaware <span class="math inline">\(\widehat{\mu}^H\)</span>, and corrective <span class="math inline">\(\widehat{\mu}^C\)</span> premiums for scenarios 1, 2, and 3 in the Example as a function of <span class="math inline">\(x_1\)</span>, <span class="math inline">\(x_2\)</span>, and <span class="math inline">\(d\)</span>.
</figcaption>
<div aria-describedby="fig-est_premiums_AHC-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figs/graph_premiumsdense_AHC_perpop.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;2.3: Estimated aware \widehat{\mu}^A, hyperaware \widehat{\mu}^H, and corrective \widehat{\mu}^C premiums for scenarios 1, 2, and 3 in the Example as a function of x_1, x_2, and d."><img src="figs/graph_premiumsdense_AHC_perpop.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
</figure>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Chevalier/al:2024" class="csl-entry" role="listitem">
Chevalier, Dominik, and Marie-Pier CÃ´tÃ©. 2024. <span>â€œFrom Point to Probabilistic Gradient Boosting for Claim Frequency and Severity Prediction.â€</span> <em>arXiv Preprint</em> <a href="https://arxiv.org/abs/2412.14916">arXiv:2412.14916</a>. <a href="https://arxiv.org/abs/2412.14916">https://arxiv.org/abs/2412.14916</a>.
</div>
<div id="ref-Machado/al:2025" class="csl-entry" role="listitem">
Fernandes Machado, Agathe, Suzie Grondin, Philipp Ratz, Arthur Charpentier, and FranÃ§ois Hu. 2025. <span>â€œEquiPy: Sequential Fairness Using Optimal Transport in Python.â€</span> <em>arXiv Preprint</em> <a href="https://arxiv.org/abs/2503.09866">arXiv:2503.09866</a>. <a href="https://arxiv.org/abs/2503.09866">https://arxiv.org/abs/2503.09866</a>.
</div>
<div id="ref-Hu/al:2024" class="csl-entry" role="listitem">
Hu, Francois, Philipp Ratz, and Arthur Charpentier. 2024. <span>â€œA Sequentially Fair Mechanism for Multiple Sensitive Attributes.â€</span> <em>Proceedings of the AAAI Conference on Artificial Intelligence</em> 38 (11): 12502â€“10. <a href="https://doi.org/10.1609/aaai.v38i11.29143">https://doi.org/10.1609/aaai.v38i11.29143</a>.
</div>
<div id="ref-Ke/al:2017" class="csl-entry" role="listitem">
Ke, Guolin, Qi Meng, Thomas Finley, Taifeng Wang, Wei Chen, Weidong Ma, Qiwei Ye, and Tie-Yan Liu. 2017. <span>â€œLight<span>GBM</span>: A Highly Efficient Gradient Boosting Decision Tree.â€</span> <em>Advances in Neural Information Processing Systems</em> 30: 3146â€“54.
</div>
<div id="ref-Lindholm/al:2022" class="csl-entry" role="listitem">
Lindholm, Mathias, Ronald Richman, Andreas Tsanakas, and Mario V WÃ¼thrich. 2022. <span>â€œDiscrimination-Free Insurance Pricing.â€</span> <em>ASTIN Bulletin</em> 52 (1): 55â€“89.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./1_simul_dataset.html" class="pagination-link" aria-label="Example setup and simulations">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Example setup and simulations</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./3_local.html" class="pagination-link" aria-label="Actuarial local metrics">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Actuarial local metrics</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize || "1.2em",
          commentDelimiter: el.dataset.commentDelimiter || "//",
          lineNumber: el.dataset.lineNumber === "true" ? true : false,
          lineNumberPunc: el.dataset.lineNumberPunc || ":",
          noEnd: el.dataset.noEnd === "true" ? true : false,
          titlePrefix: el.dataset.captionPrefix || "Algorithm"
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>
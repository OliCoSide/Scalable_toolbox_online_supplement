<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>6&nbsp; Integrated framework â€“ A scalable toolbox for exposing indirect discrimination in insurance rates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./9_references.html" rel="next">
<link href="./5_partitioning.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-de0027c6417e353ce4980619e2136061.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});

</script>

<script type="text/x-mathjax-config">

	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {

	   MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';

		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';

		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';

		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';

		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';

		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';

		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';

		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';





		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';

		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';

		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';

		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';

		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';

	});

</script>



<link rel="stylesheet" href="extras/style.css">
</head>

<body class="nav-sidebar floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">A scalable toolbox for exposing indirect discrimination in insurance rates</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/olicoside/Scalable_toolbox_online_supplement"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./6_integrated_framework.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Integrated framework</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_simul_dataset.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Example setup and simulations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_training_spectrum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimating the five fairness premiums</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3_local.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Actuarial local metrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_dimensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Measuring the dimensions of fairness</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5_partitioning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Partitioning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6_integrated_framework.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Integrated framework</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./9_references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#download-disparity-tables" id="toc-download-disparity-tables" class="nav-link active" data-scroll-target="#download-disparity-tables"><span class="header-section-number">6.1</span> Download Disparity Tables</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">




<style>

#progress-bar {

  height: 4px;

  background: #004A8D;

  position: fixed;

  top: 0;

  left: 0;

  z-index: 9999;

  width: 0%;

  transition: width 0.2s ease-out;

}

</style>



<script>

document.addEventListener('scroll', () => {

  const scrollTop = window.scrollY || document.documentElement.scrollTop;

  const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;

  const progress = (scrollTop / docHeight) * 100;

  document.getElementById('progress-bar').style.width = progress + '%';

});

</script>



<div id="progress-bar"></div>



<div style="

  position: fixed;

  top: 450px;

  left: 0;

  padding: 0.75em 1em;

  background: #f3f4f6;

  border-right: 1px solid #dddddd;

  border-radius: 12px 0 0 12px;

  font-size: 0.90em;

  font-family: 'Helvetica Neue', sans-serif;

  box-shadow: 4px 4px 8px rgba(0,0,0,0.08);

  z-index: 1000;

  max-width: 260px;

">

  <a href="https://www.casact.org/publications-research/research/research-paper-series-race-and-insurance-pricing" target="_blank" style="

    text-decoration: none;

    color: #004A8D;

    display: flex;

    align-items: center;

    font-weight: 500;

  ">

    <img src="img/logo_cas.png" alt="CAS Logo" style="max-width: 32px; margin-right: 0.4em;">

    Open main paper ðŸ”—

  </a>

</div>


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-integrated" class="quarto-section-identifier"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Integrated framework</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>This section displays how the scalable toolbox may be combined into a comprehensive monitoring excel table.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Packages for this section</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(latex2exp)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(partykit) <span class="co"># to predict the evtree from dictionnary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Data for this section</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>the_CAS_colors_full <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'#F89708'</span>, <span class="st">'#FDB922'</span>, <span class="st">'#FED35D'</span>, <span class="st">'#95CDF8'</span>, <span class="st">'#205ED5'</span>, <span class="st">'#142345'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>marg_dist <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">'preds/the_empirical_proportions.rds'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>dictionnary_leaves_trees <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">'evtree/dictionnary_leaves_trees.rds'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>group_grid_stats <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(<span class="st">'preds/group_grid_stats.json'</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>group_pop_stats <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(<span class="st">'preds/group_pop_stats.json'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Functions for this section (long)</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to calculate summaries</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>calculate_summary <span class="ot">&lt;-</span> <span class="cf">function</span>(column, variable_name, summary_functions) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  summary_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">character</span>(), <span class="at">Statistic =</span> <span class="fu">character</span>(), <span class="at">Value =</span> <span class="fu">numeric</span>())</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (func <span class="cf">in</span> summary_functions) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">d+$"</span>, func)) {  <span class="co"># Quantile (VaR)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      quantile_value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(func)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="fu">quantile</span>(column, <span class="at">probs =</span> quantile_value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"VaR "</span>, func)  <span class="co"># Clear label</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      summary_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_df, <span class="fu">data.frame</span>(<span class="at">Variable =</span> variable_name, <span class="at">Statistic =</span> label, <span class="at">Value =</span> value))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"^TVaR </span><span class="sc">\\</span><span class="st">d*</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">d+$"</span>, func)) {  <span class="co"># Tail Value at Risk (TVaR)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      quantile_value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sub</span>(<span class="st">"TVaR "</span>, <span class="st">""</span>, func))  <span class="co"># Extract quantile</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      var_value <span class="ot">&lt;-</span> <span class="fu">quantile</span>(column, <span class="at">probs =</span> quantile_value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      tvar_value <span class="ot">&lt;-</span> <span class="fu">mean</span>(column[column <span class="sc">&gt;=</span> var_value], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"TVaR "</span>, quantile_value)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      summary_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_df, <span class="fu">data.frame</span>(<span class="at">Variable =</span> variable_name, <span class="at">Statistic =</span> label, <span class="at">Value =</span> tvar_value))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (func <span class="sc">==</span> <span class="st">"mean"</span>) {  <span class="co"># Mean</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="fu">mean</span>(column, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="st">"Mean"</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      summary_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_df, <span class="fu">data.frame</span>(<span class="at">Variable =</span> variable_name, <span class="at">Statistic =</span> label, <span class="at">Value =</span> value))</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (func <span class="sc">==</span> <span class="st">"std"</span>) {  <span class="co"># Standard deviation</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="fu">sd</span>(column, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)  <span class="co"># Sample standard deviation</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="st">"Std"</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>      summary_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_df, <span class="fu">data.frame</span>(<span class="at">Variable =</span> variable_name, <span class="at">Statistic =</span> label, <span class="at">Value =</span> value))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"^%</span><span class="sc">\\</span><span class="st">d+$"</span>, func)) {  <span class="co"># Percentage of specific value</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>      target_value <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sub</span>(<span class="st">"%"</span>, <span class="st">""</span>, func))</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="fu">sum</span>(column <span class="sc">==</span> target_value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(column))</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"% of "</span>, target_value)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      summary_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_df, <span class="fu">data.frame</span>(<span class="at">Variable =</span> variable_name, <span class="at">Statistic =</span> label, <span class="at">Value =</span> value))</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Unsupported summary function:"</span>, func, <span class="st">"for variable"</span>, variable_name))</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_df)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>summarize_demographics <span class="ot">&lt;-</span> <span class="cf">function</span>(data, sensitive, variables, <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'0.1'</span>, <span class="st">'mean'</span>, <span class="st">'0.9'</span>, <span class="st">'%0'</span>)) {</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(data)) <span class="fu">stop</span>(<span class="st">"Input `data` must be a data frame."</span>)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(variables <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"Some specified variables are not in the dataset."</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(sensitive <span class="sc">%in%</span> variables) variables <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(variables, sensitive)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize the summary output</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="st">'Observations'</span>, <span class="at">Statistic =</span> <span class="st">'Count'</span>, <span class="at">Value =</span> <span class="fu">nrow</span>(data), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over specified variables</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> <span class="fu">c</span>(sensitive, variables)) {</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.numeric</span>(data[[var]])) {</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>      numeric_summary <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(data[[var]], var, summary_functions)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, numeric_summary)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">is.factor</span>(data[[var]]) <span class="sc">||</span> <span class="fu">is.character</span>(data[[var]])) {</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Categorical: Append (c) to variable name</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>      categorical_var <span class="ot">&lt;-</span> <span class="fu">paste0</span>(var, <span class="st">" (c)"</span>)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(var <span class="sc">==</span> sensitive) categorical_var <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'(Sensitive) '</span>, categorical_var)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Count occurrences for all levels</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>      counts <span class="ot">&lt;-</span> <span class="fu">table</span>(data[[var]], <span class="at">useNA =</span> <span class="st">"no"</span>)  <span class="co"># Exclude NA from counts</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>      levels_percent <span class="ot">&lt;-</span> counts <span class="sc">/</span> <span class="fu">sum</span>(counts)  <span class="co"># Proportion</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create summary table</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>      category_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">Variable =</span> <span class="fu">rep</span>(categorical_var, <span class="fu">length</span>(counts)),</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">Statistic =</span> <span class="fu">paste0</span>(<span class="st">"lvl % : "</span>, <span class="fu">names</span>(counts)),  <span class="co"># Clearer level labels</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">Value =</span> <span class="fu">as.numeric</span>(levels_percent)  <span class="co"># Proportions, no *100</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">names</span>(counts)) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="st">'1'</span> <span class="sc">%in%</span> <span class="fu">names</span>(counts)){</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>        category_summary <span class="ot">&lt;-</span> category_summary[<span class="fu">which</span>(<span class="fu">names</span>(counts) <span class="sc">==</span> <span class="st">'1'</span>),]</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, category_summary)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Skip unsupported types</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Variable"</span>, var, <span class="st">"is not numeric or categorical. Skipping."</span>))</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(summary_table) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_table)</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"statmod"</span>)) <span class="fu">install.packages</span>(<span class="st">"statmod"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(statmod)</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>summarize_loss_premium <span class="ot">&lt;-</span> <span class="cf">function</span>(data, loss_col, premium_col, <span class="at">distribution =</span> <span class="st">"normal"</span>) {</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(data)) <span class="fu">stop</span>(<span class="st">"Input `data` must be a data frame."</span>)</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(loss_col <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"Loss column not found in data."</span>)</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(premium_col <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"Premium column not found in data."</span>)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter non-NA values</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>  valid_data <span class="ot">&lt;-</span> data[<span class="sc">!</span><span class="fu">is.na</span>(data[[loss_col]]) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(data[[premium_col]]), ]</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(valid_data) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No valid data after removing NA values."</span>)</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize summary table</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">character</span>(), <span class="at">Statistic =</span> <span class="fu">character</span>(), <span class="at">Value =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add summaries for loss and premium</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>  loss_summary <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(valid_data[[loss_col]], <span class="st">"Loss"</span>, <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'%0'</span>, <span class="st">'mean'</span>))</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>  severity_summary <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(valid_data[[loss_col]][valid_data[[loss_col]] <span class="sc">&gt;</span> <span class="dv">0</span>], <span class="st">"Severity"</span>, <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'mean'</span>, <span class="st">'0.95'</span>, <span class="st">'TVaR 0.95'</span>))</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>  premium_summary <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(valid_data[[premium_col]], <span class="st">"Premium"</span>, <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'0.05'</span>, <span class="st">'mean'</span>, <span class="st">'0.95'</span>))</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add MAE (Mean Absolute Error)</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>  mae <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(valid_data[[loss_col]] <span class="sc">-</span> valid_data[[premium_col]]), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>  perf_summary_temp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="st">"Performance metrics of price"</span>, <span class="at">Statistic =</span> <span class="st">"MAE"</span>, <span class="at">Value =</span> mae)</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate deviance</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>  deviance <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tolower</span>(distribution),</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    <span class="st">"normal"</span> <span class="ot">=</span> {</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="fu">mean</span>((valid_data[[loss_col]] <span class="sc">-</span> valid_data[[premium_col]])<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="st">"Normal"</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">value =</span> value, <span class="at">label =</span> label)</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"poisson"</span> <span class="ot">=</span> {</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>(valid_data[[premium_col]] <span class="sc">&lt;=</span> <span class="dv">0</span>)) <span class="fu">stop</span>(<span class="st">"Premiums must be &gt; 0 for Poisson."</span>)</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>(valid_data[[loss_col]] <span class="sc">*</span> <span class="fu">log</span>(valid_data[[loss_col]] <span class="sc">/</span> valid_data[[premium_col]]) <span class="sc">-</span> </span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>                         (valid_data[[loss_col]] <span class="sc">-</span> valid_data[[premium_col]]), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="st">"Poisson"</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">value =</span> value, <span class="at">label =</span> label)</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>    <span class="st">"binary"</span> <span class="ot">=</span> {</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>(valid_data[[loss_col]] <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">|</span> valid_data[[loss_col]] <span class="sc">&gt;</span> <span class="dv">1</span>)) <span class="fu">stop</span>(<span class="st">"Losses must be in [0,1] for binary."</span>)</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sum</span>(</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>        valid_data[[loss_col]] <span class="sc">*</span> <span class="fu">log</span>(valid_data[[premium_col]]) <span class="sc">+</span> </span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>          (<span class="dv">1</span> <span class="sc">-</span> valid_data[[loss_col]]) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">-</span> valid_data[[premium_col]]), </span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>        <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="st">"Binary"</span></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">value =</span> value, <span class="at">label =</span> label)</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tweedie"</span> <span class="ot">=</span> {</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"statmod"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">stop</span>(<span class="st">"Install the 'statmod' package for Tweedie distribution."</span>)</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> statmod<span class="sc">::</span><span class="fu">tweedie.profile</span>(valid_data[[loss_col]] <span class="sc">~</span> valid_data[[premium_col]])<span class="sc">$</span>p.max</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="fu">sum</span>(</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>        statmod<span class="sc">::</span><span class="fu">tweedie.dev</span>(valid_data[[loss_col]], valid_data[[premium_col]], <span class="at">p =</span> p),</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>        <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>      label <span class="ot">&lt;-</span> <span class="st">"Tweedie"</span></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">value =</span> value, <span class="at">label =</span> label)</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Unsupported distribution type. Choose from 'normal', 'poisson', 'binary', or 'tweedie'."</span>)</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>  perf_summary <span class="ot">&lt;-</span> <span class="fu">rbind</span>(perf_summary_temp, <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="st">"Performance metrics of price"</span>,</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">Statistic =</span> <span class="fu">paste0</span>(<span class="st">'Dev. '</span>, deviance<span class="sc">$</span>label),</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">Value =</span> deviance<span class="sc">$</span>value))</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine all summaries</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(loss_summary, severity_summary, premium_summary, perf_summary)</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(summary_table) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_table)</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required package for Wasserstein distance</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"transport"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"transport"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(transport)</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>summarize_loss_n_price_per_group <span class="ot">&lt;-</span> <span class="cf">function</span>(data, loss_col, premium_col, protected_group_col, pdx_col, </span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) {</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(loss_col, premium_col, protected_group_col, pdx_col)</span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(required_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"Some required columns are not in the dataset."</span>)</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(levels) <span class="sc">!=</span> <span class="dv">2</span>) <span class="fu">stop</span>(<span class="st">"The 'levels' argument must specify exactly two levels for the protected group."</span>)</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter non-NA values</span></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>  valid_data <span class="ot">&lt;-</span> data[<span class="fu">complete.cases</span>(data[, required_cols]), ]</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(valid_data) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No valid data after removing NA values."</span>)</span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check which specified levels are present</span></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>  present_levels <span class="ot">&lt;-</span> levels[levels <span class="sc">%in%</span> <span class="fu">unique</span>(valid_data[[protected_group_col]])]</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize the summary output</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">character</span>(), <span class="at">Statistic =</span> <span class="fu">character</span>(), <span class="at">Value =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Premium statistics mean</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (group <span class="cf">in</span> levels) {</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (group <span class="sc">%in%</span> present_levels) {</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>      group_data <span class="ot">&lt;-</span> valid_data[valid_data[[protected_group_col]] <span class="sc">==</span> group, ]</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>      premium_data <span class="ot">&lt;-</span> group_data[[premium_col]]</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Premium summaries</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>      premium_summary <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(premium_data,</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">paste0</span>(<span class="st">"Mean price"</span>),</span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">summary_functions =</span> <span class="st">'mean'</span>)</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>      premium_summary<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, group)</span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, premium_summary)</span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add NA rows for missing group</span></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>      na_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="st">"Mean price"</span>, <span class="at">Statistic =</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, group),</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Value =</span> <span class="cn">NA</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, na_summary)</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Premium statistics Var0.95</span></span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (group <span class="cf">in</span> levels) {</span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (group <span class="sc">%in%</span> present_levels) {</span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>      group_data <span class="ot">&lt;-</span> valid_data[valid_data[[protected_group_col]] <span class="sc">==</span> group, ]</span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>      premium_data <span class="ot">&lt;-</span> group_data[[premium_col]]</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>      loss_data <span class="ot">&lt;-</span> group_data[[loss_col]]</span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Premium summaries</span></span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>      premium_summary <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(premium_data,</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">paste0</span>(<span class="st">"VaR 0.95 of price"</span>),</span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">summary_functions =</span> <span class="st">'0.95'</span>)</span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>      premium_summary<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, group)</span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, premium_summary)</span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add NA rows for missing group</span></span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a>      na_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="st">"VaR 0.95 of price"</span>,</span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Statistic =</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, group),</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Value =</span> <span class="cn">NA</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, na_summary)</span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loss Ratio</span></span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (group <span class="cf">in</span> levels) {</span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (group <span class="sc">%in%</span> present_levels) {</span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>      group_data <span class="ot">&lt;-</span> valid_data[valid_data[[protected_group_col]] <span class="sc">==</span> group, ]</span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a>      premium_data <span class="ot">&lt;-</span> group_data[[premium_col]]</span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a>      loss_data <span class="ot">&lt;-</span> group_data[[loss_col]]</span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Premium summaries</span></span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>      loss_ratio <span class="ot">&lt;-</span> <span class="fu">mean</span>(loss_data, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(premium_data, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>      loss_ratio_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>        <span class="at">Variable =</span> <span class="st">"Loss Ratio"</span>,</span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>        <span class="at">Statistic =</span> <span class="fu">paste0</span>(<span class="st">"D="</span>, group),</span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a>        <span class="at">Value =</span> loss_ratio</span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, loss_ratio_summary)</span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Add NA rows for missing group</span></span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>      na_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="st">"Mean price"</span>, <span class="at">Statistic =</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, group),</span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Value =</span> <span class="cn">NA</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, na_summary)</span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Average propensity</span></span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>  propensity <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">ifelse</span>(group_data[[protected_group_col]] <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a>                            group_data[[pdx_col]], </span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">1</span> <span class="sc">-</span> group_data[[pdx_col]]), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a>  propensity_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> <span class="st">"P(D=1|X)"</span>,</span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">Statistic =</span> <span class="st">"Mean"</span>,</span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a>    <span class="at">Value =</span> propensity</span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, propensity_summary)</span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute Wasserstein distance for the specified levels if both are present</span></span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(levels <span class="sc">%in%</span> present_levels)) {</span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a>    group_a <span class="ot">&lt;-</span> valid_data[valid_data[[protected_group_col]] <span class="sc">==</span> levels[<span class="dv">1</span>], premium_col]</span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a>    group_b <span class="ot">&lt;-</span> valid_data[valid_data[[protected_group_col]] <span class="sc">==</span> levels[<span class="dv">2</span>], premium_col]</span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if both groups have sufficient observations</span></span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(group_a) <span class="sc">&gt;</span> <span class="dv">5</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(group_b) <span class="sc">&gt;</span> <span class="dv">5</span>) {</span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a>      wd <span class="ot">&lt;-</span> <span class="fu">wasserstein1d</span>(group_a, group_b)</span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a>      wd <span class="ot">&lt;-</span> <span class="cn">NA</span>  <span class="co"># Assign NA if one or both groups have insufficient data</span></span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If one or both levels are missing, output NA for Wasserstein</span></span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a>    wd <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb3-280"><a href="#cb3-280" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-281"><a href="#cb3-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-282"><a href="#cb3-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add Wasserstein Distance to the Summary Table</span></span>
<span id="cb3-283"><a href="#cb3-283" aria-hidden="true" tabindex="-1"></a>  wd_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-284"><a href="#cb3-284" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> <span class="st">"Wasserstein Distance"</span>,</span>
<span id="cb3-285"><a href="#cb3-285" aria-hidden="true" tabindex="-1"></a>    <span class="at">Statistic =</span> <span class="fu">paste</span>(levels[<span class="dv">1</span>], <span class="st">"vs"</span>, levels[<span class="dv">2</span>]),</span>
<span id="cb3-286"><a href="#cb3-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">Value =</span> wd</span>
<span id="cb3-287"><a href="#cb3-287" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-288"><a href="#cb3-288" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, wd_summary)</span>
<span id="cb3-289"><a href="#cb3-289" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-290"><a href="#cb3-290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(summary_table) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-291"><a href="#cb3-291" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-292"><a href="#cb3-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_table)</span>
<span id="cb3-293"><a href="#cb3-293" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-294"><a href="#cb3-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-295"><a href="#cb3-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-296"><a href="#cb3-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-297"><a href="#cb3-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-298"><a href="#cb3-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-299"><a href="#cb3-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-300"><a href="#cb3-300" aria-hidden="true" tabindex="-1"></a>summarize_fairness_spectrum <span class="ot">&lt;-</span> <span class="cf">function</span>(data, fairness_cols, <span class="at">spectrum_labels =</span> <span class="cn">NULL</span>, <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'mean'</span>)) {</span>
<span id="cb3-301"><a href="#cb3-301" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-302"><a href="#cb3-302" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(data)) <span class="fu">stop</span>(<span class="st">"Input `data` must be a data frame."</span>)</span>
<span id="cb3-303"><a href="#cb3-303" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(fairness_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"Some specified fairness columns are not in the dataset."</span>)</span>
<span id="cb3-304"><a href="#cb3-304" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(spectrum_labels) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(spectrum_labels) <span class="sc">!=</span> <span class="fu">length</span>(fairness_cols)) {</span>
<span id="cb3-305"><a href="#cb3-305" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"The length of 'spectrum_labels' must match the length of 'fairness_cols'."</span>)</span>
<span id="cb3-306"><a href="#cb3-306" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-307"><a href="#cb3-307" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-308"><a href="#cb3-308" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use column names as default labels if spectrum_labels is not provided</span></span>
<span id="cb3-309"><a href="#cb3-309" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(spectrum_labels)) spectrum_labels <span class="ot">&lt;-</span> fairness_cols</span>
<span id="cb3-310"><a href="#cb3-310" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-311"><a href="#cb3-311" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize the summary output</span></span>
<span id="cb3-312"><a href="#cb3-312" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">character</span>(), <span class="at">Statistic =</span> <span class="fu">character</span>(), <span class="at">Value =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-313"><a href="#cb3-313" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-314"><a href="#cb3-314" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over specified fairness columns in the order provided</span></span>
<span id="cb3-315"><a href="#cb3-315" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(fairness_cols)) {</span>
<span id="cb3-316"><a href="#cb3-316" aria-hidden="true" tabindex="-1"></a>    fairness_col <span class="ot">&lt;-</span> fairness_cols[i]</span>
<span id="cb3-317"><a href="#cb3-317" aria-hidden="true" tabindex="-1"></a>    spectrum_label <span class="ot">&lt;-</span> spectrum_labels[i]</span>
<span id="cb3-318"><a href="#cb3-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-319"><a href="#cb3-319" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the column is numeric</span></span>
<span id="cb3-320"><a href="#cb3-320" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.numeric</span>(data[[fairness_col]])) {</span>
<span id="cb3-321"><a href="#cb3-321" aria-hidden="true" tabindex="-1"></a>      <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Fairness column"</span>, fairness_col, <span class="st">"is not numeric. Skipping."</span>))</span>
<span id="cb3-322"><a href="#cb3-322" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb3-323"><a href="#cb3-323" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-324"><a href="#cb3-324" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-325"><a href="#cb3-325" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate summaries and append to the summary table</span></span>
<span id="cb3-326"><a href="#cb3-326" aria-hidden="true" tabindex="-1"></a>    fairness_summary <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(data[[fairness_col]], spectrum_label, summary_functions)</span>
<span id="cb3-327"><a href="#cb3-327" aria-hidden="true" tabindex="-1"></a>    summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, fairness_summary)</span>
<span id="cb3-328"><a href="#cb3-328" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-329"><a href="#cb3-329" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-330"><a href="#cb3-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(summary_table) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-331"><a href="#cb3-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_table)</span>
<span id="cb3-332"><a href="#cb3-332" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-333"><a href="#cb3-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-334"><a href="#cb3-334" aria-hidden="true" tabindex="-1"></a>summarize_local_measures <span class="ot">&lt;-</span> <span class="cf">function</span>(data,</span>
<span id="cb3-335"><a href="#cb3-335" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">split_measures =</span> <span class="st">'proxy_vuln'</span>,</span>
<span id="cb3-336"><a href="#cb3-336" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">whole_pop_measures =</span> <span class="fu">c</span>(<span class="st">'risk_spread'</span>, <span class="st">'fair_range'</span>, <span class="st">'parity_cost'</span>),</span>
<span id="cb3-337"><a href="#cb3-337" aria-hidden="true" tabindex="-1"></a>                                     protected_group_col,</span>
<span id="cb3-338"><a href="#cb3-338" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'mean'</span>, <span class="st">'TVaR 0.95'</span>)) {</span>
<span id="cb3-339"><a href="#cb3-339" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-340"><a href="#cb3-340" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(split_measures, whole_pop_measures, protected_group_col)</span>
<span id="cb3-341"><a href="#cb3-341" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(required_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"Some required columns are not in the dataset."</span>)</span>
<span id="cb3-342"><a href="#cb3-342" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-343"><a href="#cb3-343" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter non-NA values</span></span>
<span id="cb3-344"><a href="#cb3-344" aria-hidden="true" tabindex="-1"></a>  valid_data <span class="ot">&lt;-</span> data[<span class="fu">complete.cases</span>(data[, required_cols]), ]</span>
<span id="cb3-345"><a href="#cb3-345" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(valid_data) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No valid data after removing NA values."</span>)</span>
<span id="cb3-346"><a href="#cb3-346" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-347"><a href="#cb3-347" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize the summary output</span></span>
<span id="cb3-348"><a href="#cb3-348" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">character</span>(), <span class="at">Statistic =</span> <span class="fu">character</span>(), <span class="at">Value =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-349"><a href="#cb3-349" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-350"><a href="#cb3-350" aria-hidden="true" tabindex="-1"></a>  <span class="do">### split_measures</span></span>
<span id="cb3-351"><a href="#cb3-351" aria-hidden="true" tabindex="-1"></a>  the_levels <span class="ot">&lt;-</span> <span class="fu">unique</span>(valid_data[[protected_group_col]])</span>
<span id="cb3-352"><a href="#cb3-352" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (smry_fn <span class="cf">in</span> summary_functions) {</span>
<span id="cb3-353"><a href="#cb3-353" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (split_meas <span class="cf">in</span> split_measures) {</span>
<span id="cb3-354"><a href="#cb3-354" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(the_levels) <span class="sc">+</span> <span class="dv">1</span>)) {</span>
<span id="cb3-355"><a href="#cb3-355" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb3-356"><a href="#cb3-356" aria-hidden="true" tabindex="-1"></a>          summary_all_data <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(valid_data[[split_meas]], <span class="st">'temp'</span>, <span class="at">summary_functions =</span> smry_fn)</span>
<span id="cb3-357"><a href="#cb3-357" aria-hidden="true" tabindex="-1"></a>          summary_all_data<span class="sc">$</span>Variable <span class="ot">&lt;-</span> <span class="fu">paste0</span>(summary_all_data<span class="sc">$</span>Statistic, <span class="st">' of '</span>, split_meas)</span>
<span id="cb3-358"><a href="#cb3-358" aria-hidden="true" tabindex="-1"></a>          summary_all_data<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="st">'All'</span></span>
<span id="cb3-359"><a href="#cb3-359" aria-hidden="true" tabindex="-1"></a>          summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_all_data)</span>
<span id="cb3-360"><a href="#cb3-360" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb3-361"><a href="#cb3-361" aria-hidden="true" tabindex="-1"></a>          j <span class="ot">&lt;-</span> i <span class="sc">-</span> <span class="dv">1</span> </span>
<span id="cb3-362"><a href="#cb3-362" aria-hidden="true" tabindex="-1"></a>          partial_data <span class="ot">&lt;-</span> valid_data[[split_meas]][valid_data[[protected_group_col]] <span class="sc">==</span> the_levels[j]]</span>
<span id="cb3-363"><a href="#cb3-363" aria-hidden="true" tabindex="-1"></a>          summary_protected <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(partial_data, <span class="st">'temp'</span>, <span class="at">summary_functions =</span> smry_fn)</span>
<span id="cb3-364"><a href="#cb3-364" aria-hidden="true" tabindex="-1"></a>          summary_protected<span class="sc">$</span>Variable <span class="ot">&lt;-</span> <span class="fu">paste0</span>(summary_protected<span class="sc">$</span>Statistic, <span class="st">' of '</span>,split_meas)</span>
<span id="cb3-365"><a href="#cb3-365" aria-hidden="true" tabindex="-1"></a>          summary_protected<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, the_levels[j])</span>
<span id="cb3-366"><a href="#cb3-366" aria-hidden="true" tabindex="-1"></a>          summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_protected)</span>
<span id="cb3-367"><a href="#cb3-367" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-368"><a href="#cb3-368" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb3-369"><a href="#cb3-369" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-370"><a href="#cb3-370" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-371"><a href="#cb3-371" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-372"><a href="#cb3-372" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (other_meas <span class="cf">in</span> whole_pop_measures) {</span>
<span id="cb3-373"><a href="#cb3-373" aria-hidden="true" tabindex="-1"></a>    summary_all_data <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(valid_data[[other_meas]], other_meas, <span class="at">summary_functions =</span> <span class="st">'mean'</span>)</span>
<span id="cb3-374"><a href="#cb3-374" aria-hidden="true" tabindex="-1"></a>    summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_all_data)</span>
<span id="cb3-375"><a href="#cb3-375" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-376"><a href="#cb3-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-377"><a href="#cb3-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(summary_table) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-378"><a href="#cb3-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_table)</span>
<span id="cb3-379"><a href="#cb3-379" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-380"><a href="#cb3-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-381"><a href="#cb3-381" aria-hidden="true" tabindex="-1"></a>compute_sb0_sb1 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, mua_col, mub_col, d_col, pd) {</span>
<span id="cb3-382"><a href="#cb3-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-383"><a href="#cb3-383" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(data)) <span class="fu">stop</span>(<span class="st">"Input `data` must be a data frame."</span>)</span>
<span id="cb3-384"><a href="#cb3-384" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(mua_col <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"mu_A column not found in the dataset."</span>)</span>
<span id="cb3-385"><a href="#cb3-385" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(mub_col <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"mu_B column not found in the dataset."</span>)</span>
<span id="cb3-386"><a href="#cb3-386" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(d_col <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"D column not found in the dataset."</span>)</span>
<span id="cb3-387"><a href="#cb3-387" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(pd) <span class="sc">!=</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">any</span>(pd <span class="sc">&lt;=</span> <span class="dv">0</span>) <span class="sc">||</span> <span class="fu">sum</span>(pd) <span class="sc">!=</span> <span class="dv">1</span>) <span class="fu">stop</span>(<span class="st">"PD must be a valid probability vector of length 2 summing to 1."</span>)</span>
<span id="cb3-388"><a href="#cb3-388" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-389"><a href="#cb3-389" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract the columns</span></span>
<span id="cb3-390"><a href="#cb3-390" aria-hidden="true" tabindex="-1"></a>  mu_A <span class="ot">&lt;-</span> data[[mua_col]]</span>
<span id="cb3-391"><a href="#cb3-391" aria-hidden="true" tabindex="-1"></a>  mu_B <span class="ot">&lt;-</span> data[[mub_col]]</span>
<span id="cb3-392"><a href="#cb3-392" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">&lt;-</span> data[[d_col]]</span>
<span id="cb3-393"><a href="#cb3-393" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-394"><a href="#cb3-394" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute mu_B0 and mu_B1</span></span>
<span id="cb3-395"><a href="#cb3-395" aria-hidden="true" tabindex="-1"></a>  mu_B0 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb3-396"><a href="#cb3-396" aria-hidden="true" tabindex="-1"></a>                (mu_A <span class="sc">-</span> pd[<span class="dv">2</span>] <span class="sc">*</span> mu_B) <span class="sc">/</span> pd[<span class="dv">1</span>],  <span class="co"># Formula for mu_B0 when D = 1</span></span>
<span id="cb3-397"><a href="#cb3-397" aria-hidden="true" tabindex="-1"></a>                mu_B)                          <span class="co"># mu_B0 = mu_B when D = 0</span></span>
<span id="cb3-398"><a href="#cb3-398" aria-hidden="true" tabindex="-1"></a>  mu_B1 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb3-399"><a href="#cb3-399" aria-hidden="true" tabindex="-1"></a>                (mu_A <span class="sc">-</span> pd[<span class="dv">1</span>] <span class="sc">*</span> mu_B) <span class="sc">/</span> pd[<span class="dv">2</span>],  <span class="co"># Formula for mu_B1 when D = 0</span></span>
<span id="cb3-400"><a href="#cb3-400" aria-hidden="true" tabindex="-1"></a>                mu_B)                          <span class="co"># mu_B1 = mu_B when D = 1</span></span>
<span id="cb3-401"><a href="#cb3-401" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-402"><a href="#cb3-402" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return the modified dataset with mu_B0 and mu_B1</span></span>
<span id="cb3-403"><a href="#cb3-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb3-404"><a href="#cb3-404" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(mu_B0, mu_B1)</span>
<span id="cb3-405"><a href="#cb3-405" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-406"><a href="#cb3-406" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-407"><a href="#cb3-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-408"><a href="#cb3-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-409"><a href="#cb3-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-410"><a href="#cb3-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-411"><a href="#cb3-411" aria-hidden="true" tabindex="-1"></a>implied_propensity <span class="ot">&lt;-</span> <span class="cf">function</span>(data, premium_col, mua_col, mub_col, d_col, pd){</span>
<span id="cb3-412"><a href="#cb3-412" aria-hidden="true" tabindex="-1"></a>  sb0sb1 <span class="ot">&lt;-</span> <span class="fu">compute_sb0_sb1</span>(data, <span class="at">mua_col =</span> mua_col, <span class="at">mub_col =</span> mub_col, <span class="at">d_col =</span> d_col, <span class="at">pd =</span> pd)</span>
<span id="cb3-413"><a href="#cb3-413" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-414"><a href="#cb3-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb3-415"><a href="#cb3-415" aria-hidden="true" tabindex="-1"></a>    (data[[premium_col]] <span class="sc">-</span> sb0sb1[[<span class="dv">1</span>]])<span class="sc">/</span>(sb0sb1[[<span class="dv">2</span>]] <span class="sc">-</span> sb0sb1[[<span class="dv">1</span>]])</span>
<span id="cb3-416"><a href="#cb3-416" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-417"><a href="#cb3-417" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-418"><a href="#cb3-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-419"><a href="#cb3-419" aria-hidden="true" tabindex="-1"></a>summarize_premium_spectrum <span class="ot">&lt;-</span> <span class="cf">function</span>(data, premium_col,</span>
<span id="cb3-420"><a href="#cb3-420" aria-hidden="true" tabindex="-1"></a>                                       mua_col,</span>
<span id="cb3-421"><a href="#cb3-421" aria-hidden="true" tabindex="-1"></a>                                       mub_col,</span>
<span id="cb3-422"><a href="#cb3-422" aria-hidden="true" tabindex="-1"></a>                                       group_col,</span>
<span id="cb3-423"><a href="#cb3-423" aria-hidden="true" tabindex="-1"></a>                                       rank_col,</span>
<span id="cb3-424"><a href="#cb3-424" aria-hidden="true" tabindex="-1"></a>                                       pd,</span>
<span id="cb3-425"><a href="#cb3-425" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'mean'</span>, <span class="st">'TVaR 0.95'</span>)) {</span>
<span id="cb3-426"><a href="#cb3-426" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-427"><a href="#cb3-427" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(premium_col, mua_col, mub_col, group_col, rank_col)</span>
<span id="cb3-428"><a href="#cb3-428" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(required_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"Some required columns are not in the dataset."</span>)</span>
<span id="cb3-429"><a href="#cb3-429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-430"><a href="#cb3-430" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute mu_B0 and mu_B1</span></span>
<span id="cb3-431"><a href="#cb3-431" aria-hidden="true" tabindex="-1"></a>  sb0sb1 <span class="ot">&lt;-</span> <span class="fu">compute_sb0_sb1</span>(data, <span class="at">mua_col =</span> mua_col, <span class="at">mub_col =</span> mub_col, <span class="at">d_col =</span> group_col, <span class="at">pd =</span> pd)</span>
<span id="cb3-432"><a href="#cb3-432" aria-hidden="true" tabindex="-1"></a>  mu_B0 <span class="ot">&lt;-</span> sb0sb1[[<span class="dv">1</span>]]</span>
<span id="cb3-433"><a href="#cb3-433" aria-hidden="true" tabindex="-1"></a>  mu_B1 <span class="ot">&lt;-</span> sb0sb1[[<span class="dv">2</span>]]</span>
<span id="cb3-434"><a href="#cb3-434" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-435"><a href="#cb3-435" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute Implied Propensity and Commercial Loading</span></span>
<span id="cb3-436"><a href="#cb3-436" aria-hidden="true" tabindex="-1"></a>  implied_prop <span class="ot">&lt;-</span> (data[[premium_col]] <span class="sc">-</span> mu_B0) <span class="sc">/</span> (mu_B1 <span class="sc">-</span> mu_B0)</span>
<span id="cb3-437"><a href="#cb3-437" aria-hidden="true" tabindex="-1"></a>  commercial_loading <span class="ot">&lt;-</span> data[[premium_col]] <span class="sc">-</span> data[[mua_col]]</span>
<span id="cb3-438"><a href="#cb3-438" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-439"><a href="#cb3-439" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize summary output</span></span>
<span id="cb3-440"><a href="#cb3-440" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">character</span>(), <span class="at">Statistic =</span> <span class="fu">character</span>(), <span class="at">Value =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-441"><a href="#cb3-441" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-442"><a href="#cb3-442" aria-hidden="true" tabindex="-1"></a>  the_levels <span class="ot">&lt;-</span> <span class="fu">unique</span>(data[[group_col]])</span>
<span id="cb3-443"><a href="#cb3-443" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-444"><a href="#cb3-444" aria-hidden="true" tabindex="-1"></a>  <span class="do">## commercial loading</span></span>
<span id="cb3-445"><a href="#cb3-445" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (smry_fn <span class="cf">in</span> summary_functions) {</span>
<span id="cb3-446"><a href="#cb3-446" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(the_levels) <span class="sc">+</span> <span class="dv">1</span>)) {</span>
<span id="cb3-447"><a href="#cb3-447" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb3-448"><a href="#cb3-448" aria-hidden="true" tabindex="-1"></a>        summary_all_data <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(commercial_loading, <span class="st">'temp'</span>, <span class="at">summary_functions =</span> smry_fn)</span>
<span id="cb3-449"><a href="#cb3-449" aria-hidden="true" tabindex="-1"></a>        summary_all_data<span class="sc">$</span>Variable <span class="ot">&lt;-</span> <span class="fu">paste0</span>(summary_all_data<span class="sc">$</span>Statistic, <span class="st">' of comm. loading'</span>)</span>
<span id="cb3-450"><a href="#cb3-450" aria-hidden="true" tabindex="-1"></a>        summary_all_data<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="st">'All'</span></span>
<span id="cb3-451"><a href="#cb3-451" aria-hidden="true" tabindex="-1"></a>        summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_all_data)</span>
<span id="cb3-452"><a href="#cb3-452" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb3-453"><a href="#cb3-453" aria-hidden="true" tabindex="-1"></a>        j <span class="ot">&lt;-</span> i <span class="sc">-</span> <span class="dv">1</span> </span>
<span id="cb3-454"><a href="#cb3-454" aria-hidden="true" tabindex="-1"></a>        partial_data <span class="ot">&lt;-</span> commercial_loading[data[[group_col]] <span class="sc">==</span> the_levels[j]]</span>
<span id="cb3-455"><a href="#cb3-455" aria-hidden="true" tabindex="-1"></a>        summary_protected <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(partial_data, <span class="st">'temp'</span>, <span class="at">summary_functions =</span> smry_fn)</span>
<span id="cb3-456"><a href="#cb3-456" aria-hidden="true" tabindex="-1"></a>        summary_protected<span class="sc">$</span>Variable <span class="ot">&lt;-</span> <span class="fu">paste0</span>(summary_protected<span class="sc">$</span>Statistic, <span class="st">' of comm. loading'</span>)</span>
<span id="cb3-457"><a href="#cb3-457" aria-hidden="true" tabindex="-1"></a>        summary_protected<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, the_levels[j])</span>
<span id="cb3-458"><a href="#cb3-458" aria-hidden="true" tabindex="-1"></a>        summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_protected)</span>
<span id="cb3-459"><a href="#cb3-459" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-460"><a href="#cb3-460" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb3-461"><a href="#cb3-461" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-462"><a href="#cb3-462" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-463"><a href="#cb3-463" aria-hidden="true" tabindex="-1"></a>  <span class="do">## propensity + rank</span></span>
<span id="cb3-464"><a href="#cb3-464" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(the_levels) <span class="sc">+</span> <span class="dv">1</span>)) {</span>
<span id="cb3-465"><a href="#cb3-465" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb3-466"><a href="#cb3-466" aria-hidden="true" tabindex="-1"></a>      summary_all_data <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(implied_prop, <span class="st">'temp'</span>, <span class="at">summary_functions =</span> <span class="st">'mean'</span>)</span>
<span id="cb3-467"><a href="#cb3-467" aria-hidden="true" tabindex="-1"></a>      summary_all_data<span class="sc">$</span>Variable <span class="ot">&lt;-</span> <span class="fu">paste0</span>(summary_all_data<span class="sc">$</span>Statistic, <span class="st">' implied propensity'</span>)</span>
<span id="cb3-468"><a href="#cb3-468" aria-hidden="true" tabindex="-1"></a>      summary_all_data<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="st">'All'</span></span>
<span id="cb3-469"><a href="#cb3-469" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_all_data)</span>
<span id="cb3-470"><a href="#cb3-470" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-471"><a href="#cb3-471" aria-hidden="true" tabindex="-1"></a>      j <span class="ot">&lt;-</span> i <span class="sc">-</span> <span class="dv">1</span> </span>
<span id="cb3-472"><a href="#cb3-472" aria-hidden="true" tabindex="-1"></a>      partial_data <span class="ot">&lt;-</span> implied_prop[data[[group_col]] <span class="sc">==</span> the_levels[j]]</span>
<span id="cb3-473"><a href="#cb3-473" aria-hidden="true" tabindex="-1"></a>      summary_protected <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(partial_data, <span class="st">'temp'</span>, <span class="at">summary_functions =</span> <span class="st">'mean'</span>)</span>
<span id="cb3-474"><a href="#cb3-474" aria-hidden="true" tabindex="-1"></a>      summary_protected<span class="sc">$</span>Variable <span class="ot">&lt;-</span> <span class="fu">paste0</span>(summary_protected<span class="sc">$</span>Statistic, <span class="st">' implied propensity'</span>)</span>
<span id="cb3-475"><a href="#cb3-475" aria-hidden="true" tabindex="-1"></a>      summary_protected<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, the_levels[j])</span>
<span id="cb3-476"><a href="#cb3-476" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_protected)</span>
<span id="cb3-477"><a href="#cb3-477" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-478"><a href="#cb3-478" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb3-479"><a href="#cb3-479" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-480"><a href="#cb3-480" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(the_levels) <span class="sc">+</span> <span class="dv">1</span>)) {</span>
<span id="cb3-481"><a href="#cb3-481" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb3-482"><a href="#cb3-482" aria-hidden="true" tabindex="-1"></a>      summary_all_data <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(data[[rank_col]], <span class="st">'temp'</span>, <span class="at">summary_functions =</span> <span class="st">'mean'</span>)</span>
<span id="cb3-483"><a href="#cb3-483" aria-hidden="true" tabindex="-1"></a>      summary_all_data<span class="sc">$</span>Variable <span class="ot">&lt;-</span> <span class="fu">paste0</span>(summary_all_data<span class="sc">$</span>Statistic, <span class="st">' rank among spectrum'</span>)</span>
<span id="cb3-484"><a href="#cb3-484" aria-hidden="true" tabindex="-1"></a>      summary_all_data<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="st">'All'</span></span>
<span id="cb3-485"><a href="#cb3-485" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_all_data)</span>
<span id="cb3-486"><a href="#cb3-486" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-487"><a href="#cb3-487" aria-hidden="true" tabindex="-1"></a>      j <span class="ot">&lt;-</span> i <span class="sc">-</span> <span class="dv">1</span> </span>
<span id="cb3-488"><a href="#cb3-488" aria-hidden="true" tabindex="-1"></a>      partial_data <span class="ot">&lt;-</span> data[[rank_col]][data[[group_col]] <span class="sc">==</span> the_levels[j]]</span>
<span id="cb3-489"><a href="#cb3-489" aria-hidden="true" tabindex="-1"></a>      summary_protected <span class="ot">&lt;-</span> <span class="fu">calculate_summary</span>(partial_data, <span class="st">'temp'</span>, <span class="at">summary_functions =</span> <span class="st">'mean'</span>)</span>
<span id="cb3-490"><a href="#cb3-490" aria-hidden="true" tabindex="-1"></a>      summary_protected<span class="sc">$</span>Variable <span class="ot">&lt;-</span> <span class="fu">paste0</span>(summary_protected<span class="sc">$</span>Statistic, <span class="st">' rank among spectrum'</span>)</span>
<span id="cb3-491"><a href="#cb3-491" aria-hidden="true" tabindex="-1"></a>      summary_protected<span class="sc">$</span>Statistic <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, the_levels[j])</span>
<span id="cb3-492"><a href="#cb3-492" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, summary_protected)</span>
<span id="cb3-493"><a href="#cb3-493" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-494"><a href="#cb3-494" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb3-495"><a href="#cb3-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-496"><a href="#cb3-496" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-497"><a href="#cb3-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(summary_table) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-498"><a href="#cb3-498" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-499"><a href="#cb3-499" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-500"><a href="#cb3-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_table)</span>
<span id="cb3-501"><a href="#cb3-501" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-502"><a href="#cb3-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-503"><a href="#cb3-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-504"><a href="#cb3-504" aria-hidden="true" tabindex="-1"></a>summarize_vulnerability <span class="ot">&lt;-</span> <span class="cf">function</span>(data, premium_col, mua_col, group_col, <span class="at">thresholds =</span> <span class="cn">NULL</span>) {</span>
<span id="cb3-505"><a href="#cb3-505" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-506"><a href="#cb3-506" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(premium_col, mua_col, group_col)</span>
<span id="cb3-507"><a href="#cb3-507" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(required_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(data))) <span class="fu">stop</span>(<span class="st">"Some required columns are not in the dataset."</span>)</span>
<span id="cb3-508"><a href="#cb3-508" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-509"><a href="#cb3-509" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute implied commercial adjustment relative to mu_A</span></span>
<span id="cb3-510"><a href="#cb3-510" aria-hidden="true" tabindex="-1"></a>  commercial_adjustment <span class="ot">&lt;-</span> (data[[premium_col]] <span class="sc">-</span> data[[mua_col]]) <span class="sc">/</span> data[[mua_col]]</span>
<span id="cb3-511"><a href="#cb3-511" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-512"><a href="#cb3-512" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize summary output</span></span>
<span id="cb3-513"><a href="#cb3-513" aria-hidden="true" tabindex="-1"></a>  summary_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Variable =</span> <span class="fu">character</span>(), <span class="at">Statistic =</span> <span class="fu">character</span>(), <span class="at">Value =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-514"><a href="#cb3-514" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-515"><a href="#cb3-515" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(thresholds)){</span>
<span id="cb3-516"><a href="#cb3-516" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">quantile</span>(commercial_adjustment, <span class="fu">c</span>(<span class="fl">0.65</span>, <span class="fl">0.75</span>))), <span class="dv">3</span>)</span>
<span id="cb3-517"><a href="#cb3-517" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-518"><a href="#cb3-518" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-519"><a href="#cb3-519" aria-hidden="true" tabindex="-1"></a>  the_levels <span class="ot">&lt;-</span> <span class="fu">unique</span>(data[[group_col]])</span>
<span id="cb3-520"><a href="#cb3-520" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-521"><a href="#cb3-521" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate % of people exceeding each threshold</span></span>
<span id="cb3-522"><a href="#cb3-522" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (threshold <span class="cf">in</span> thresholds) {</span>
<span id="cb3-523"><a href="#cb3-523" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(the_levels) <span class="sc">+</span> <span class="dv">1</span>)) {</span>
<span id="cb3-524"><a href="#cb3-524" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(i <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb3-525"><a href="#cb3-525" aria-hidden="true" tabindex="-1"></a>        percentage <span class="ot">&lt;-</span> <span class="fu">mean</span>(commercial_adjustment <span class="sc">&gt;</span> threshold, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-526"><a href="#cb3-526" aria-hidden="true" tabindex="-1"></a>        vulnerability_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-527"><a href="#cb3-527" aria-hidden="true" tabindex="-1"></a>          <span class="at">Variable =</span> <span class="fu">paste0</span>(<span class="st">"% of ppl. with (Comm. load)/(Aware)&gt;"</span>, threshold <span class="sc">*</span> <span class="dv">100</span>, <span class="st">"%"</span>),</span>
<span id="cb3-528"><a href="#cb3-528" aria-hidden="true" tabindex="-1"></a>          <span class="at">Statistic =</span> <span class="fu">paste</span>(<span class="st">"All"</span>),</span>
<span id="cb3-529"><a href="#cb3-529" aria-hidden="true" tabindex="-1"></a>          <span class="at">Value =</span> percentage</span>
<span id="cb3-530"><a href="#cb3-530" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-531"><a href="#cb3-531" aria-hidden="true" tabindex="-1"></a>        summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, vulnerability_summary)</span>
<span id="cb3-532"><a href="#cb3-532" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb3-533"><a href="#cb3-533" aria-hidden="true" tabindex="-1"></a>        j <span class="ot">&lt;-</span> i <span class="sc">-</span> <span class="dv">1</span> </span>
<span id="cb3-534"><a href="#cb3-534" aria-hidden="true" tabindex="-1"></a>        partial_data <span class="ot">&lt;-</span> commercial_adjustment[data[[group_col]] <span class="sc">==</span> the_levels[j]]</span>
<span id="cb3-535"><a href="#cb3-535" aria-hidden="true" tabindex="-1"></a>        percentage <span class="ot">&lt;-</span> <span class="fu">mean</span>(partial_data <span class="sc">&gt;</span> threshold, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-536"><a href="#cb3-536" aria-hidden="true" tabindex="-1"></a>        vulnerability_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-537"><a href="#cb3-537" aria-hidden="true" tabindex="-1"></a>          <span class="at">Variable =</span> <span class="fu">paste0</span>(<span class="st">"% of ppl. with (Comm. load)/(Aware)&gt;"</span>, threshold <span class="sc">*</span> <span class="dv">100</span>, <span class="st">"%"</span>),</span>
<span id="cb3-538"><a href="#cb3-538" aria-hidden="true" tabindex="-1"></a>          <span class="at">Statistic =</span> <span class="fu">paste0</span>(<span class="st">'D='</span>, the_levels[j]),</span>
<span id="cb3-539"><a href="#cb3-539" aria-hidden="true" tabindex="-1"></a>          <span class="at">Value =</span> percentage</span>
<span id="cb3-540"><a href="#cb3-540" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-541"><a href="#cb3-541" aria-hidden="true" tabindex="-1"></a>        summary_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_table, vulnerability_summary)</span>
<span id="cb3-542"><a href="#cb3-542" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-543"><a href="#cb3-543" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-544"><a href="#cb3-544" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-545"><a href="#cb3-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-546"><a href="#cb3-546" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-547"><a href="#cb3-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(summary_table) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-548"><a href="#cb3-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(summary_table)</span>
<span id="cb3-549"><a href="#cb3-549" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-550"><a href="#cb3-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-551"><a href="#cb3-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-552"><a href="#cb3-552" aria-hidden="true" tabindex="-1"></a>summarize_fairness_table <span class="ot">&lt;-</span> <span class="cf">function</span>(data, group_col, marg_dist,</span>
<span id="cb3-553"><a href="#cb3-553" aria-hidden="true" tabindex="-1"></a>                                     sensitive_variable,</span>
<span id="cb3-554"><a href="#cb3-554" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">top_bottom_summary =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb3-555"><a href="#cb3-555" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">demographics_variables =</span> <span class="fu">c</span>(<span class="st">"D"</span>, <span class="st">"X2"</span>, <span class="st">"X1"</span>)) {</span>
<span id="cb3-556"><a href="#cb3-556" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Validate input</span></span>
<span id="cb3-557"><a href="#cb3-557" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(data)) <span class="fu">stop</span>(<span class="st">"Input `data` must be a data frame."</span>)</span>
<span id="cb3-558"><a href="#cb3-558" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(group_col <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="fu">colnames</span>(data)))) </span>
<span id="cb3-559"><a href="#cb3-559" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"All group_col values must be '1' or valid column names in the dataset."</span>)</span>
<span id="cb3-560"><a href="#cb3-560" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>sensitive_variable <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) </span>
<span id="cb3-561"><a href="#cb3-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"The `sensitive_variable` must be a valid column name in the dataset."</span>)</span>
<span id="cb3-562"><a href="#cb3-562" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-563"><a href="#cb3-563" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Preprocess demographic variables to limit levels to max 4 (including "Other")</span></span>
<span id="cb3-564"><a href="#cb3-564" aria-hidden="true" tabindex="-1"></a>  preprocess_factors <span class="ot">&lt;-</span> <span class="cf">function</span>(data, variables) {</span>
<span id="cb3-565"><a href="#cb3-565" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (var <span class="cf">in</span> variables) {</span>
<span id="cb3-566"><a href="#cb3-566" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (var <span class="sc">%in%</span> <span class="fu">colnames</span>(data) <span class="sc">&amp;&amp;</span> (<span class="fu">is.factor</span>(data[[var]]) <span class="sc">||</span> <span class="fu">is.character</span>(data[[var]]))) {</span>
<span id="cb3-567"><a href="#cb3-567" aria-hidden="true" tabindex="-1"></a>        counts <span class="ot">&lt;-</span> <span class="fu">table</span>(data[[var]], <span class="at">useNA =</span> <span class="st">"no"</span>)</span>
<span id="cb3-568"><a href="#cb3-568" aria-hidden="true" tabindex="-1"></a>        counts <span class="ot">&lt;-</span> <span class="fu">sort</span>(counts, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-569"><a href="#cb3-569" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-570"><a href="#cb3-570" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(counts) <span class="sc">&gt;</span> <span class="dv">4</span>) {</span>
<span id="cb3-571"><a href="#cb3-571" aria-hidden="true" tabindex="-1"></a>          top_3_levels <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">head</span>(counts, <span class="dv">3</span>))</span>
<span id="cb3-572"><a href="#cb3-572" aria-hidden="true" tabindex="-1"></a>          data[[var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb3-573"><a href="#cb3-573" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(data[[var]] <span class="sc">%in%</span> top_3_levels, data[[var]], <span class="st">"Other"</span>),</span>
<span id="cb3-574"><a href="#cb3-574" aria-hidden="true" tabindex="-1"></a>            <span class="at">levels =</span> <span class="fu">c</span>(top_3_levels, <span class="st">"Other"</span>)</span>
<span id="cb3-575"><a href="#cb3-575" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb3-576"><a href="#cb3-576" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb3-577"><a href="#cb3-577" aria-hidden="true" tabindex="-1"></a>          data[[var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(data[[var]], <span class="at">levels =</span> <span class="fu">names</span>(counts))</span>
<span id="cb3-578"><a href="#cb3-578" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-579"><a href="#cb3-579" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-580"><a href="#cb3-580" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-581"><a href="#cb3-581" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(data)</span>
<span id="cb3-582"><a href="#cb3-582" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-583"><a href="#cb3-583" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-584"><a href="#cb3-584" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply preprocessing</span></span>
<span id="cb3-585"><a href="#cb3-585" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">preprocess_factors</span>(data, demographics_variables)</span>
<span id="cb3-586"><a href="#cb3-586" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-587"><a href="#cb3-587" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fetch levels of the sensitive variable</span></span>
<span id="cb3-588"><a href="#cb3-588" aria-hidden="true" tabindex="-1"></a>  sensitive_levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(<span class="fu">factor</span>(data[[sensitive_variable]]))</span>
<span id="cb3-589"><a href="#cb3-589" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-590"><a href="#cb3-590" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Helper function to tag sections</span></span>
<span id="cb3-591"><a href="#cb3-591" aria-hidden="true" tabindex="-1"></a>  add_section <span class="ot">&lt;-</span> <span class="cf">function</span>(summary_table, section_name) {</span>
<span id="cb3-592"><a href="#cb3-592" aria-hidden="true" tabindex="-1"></a>    summary_table<span class="sc">$</span>Section <span class="ot">&lt;-</span> section_name</span>
<span id="cb3-593"><a href="#cb3-593" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(summary_table)</span>
<span id="cb3-594"><a href="#cb3-594" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-595"><a href="#cb3-595" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-596"><a href="#cb3-596" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of summary functions</span></span>
<span id="cb3-597"><a href="#cb3-597" aria-hidden="true" tabindex="-1"></a>  summary_functions <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-598"><a href="#cb3-598" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Demographics"</span> <span class="ot">=</span> <span class="cf">function</span>(subdata) <span class="fu">summarize_demographics</span>(subdata,</span>
<span id="cb3-599"><a href="#cb3-599" aria-hidden="true" tabindex="-1"></a>                                                              <span class="at">sensitive =</span> sensitive_variable,</span>
<span id="cb3-600"><a href="#cb3-600" aria-hidden="true" tabindex="-1"></a>                                                              <span class="at">variables =</span> demographics_variables,</span>
<span id="cb3-601"><a href="#cb3-601" aria-hidden="true" tabindex="-1"></a>                                                              <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'mean'</span>, <span class="st">'std'</span>)),</span>
<span id="cb3-602"><a href="#cb3-602" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Loss and commercial price"</span> <span class="ot">=</span> <span class="cf">function</span>(subdata) <span class="fu">summarize_loss_premium</span>(subdata,</span>
<span id="cb3-603"><a href="#cb3-603" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">loss_col =</span> <span class="st">"Y"</span>,</span>
<span id="cb3-604"><a href="#cb3-604" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">premium_col =</span> <span class="st">"prem"</span>,</span>
<span id="cb3-605"><a href="#cb3-605" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">distribution =</span> <span class="st">'normal'</span>),</span>
<span id="cb3-606"><a href="#cb3-606" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Loss and price per group"</span> <span class="ot">=</span> <span class="cf">function</span>(subdata) <span class="fu">summarize_loss_n_price_per_group</span>(</span>
<span id="cb3-607"><a href="#cb3-607" aria-hidden="true" tabindex="-1"></a>      subdata, <span class="at">loss_col =</span> <span class="st">"Y"</span>, <span class="at">premium_col =</span> <span class="st">"prem"</span>,</span>
<span id="cb3-608"><a href="#cb3-608" aria-hidden="true" tabindex="-1"></a>      <span class="at">protected_group_col =</span> sensitive_variable, <span class="at">pdx_col =</span> <span class="st">"pdx"</span>,</span>
<span id="cb3-609"><a href="#cb3-609" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> sensitive_levels</span>
<span id="cb3-610"><a href="#cb3-610" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-611"><a href="#cb3-611" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Local Measures"</span> <span class="ot">=</span> <span class="cf">function</span>(subdata) <span class="fu">summarize_local_measures</span>(</span>
<span id="cb3-612"><a href="#cb3-612" aria-hidden="true" tabindex="-1"></a>      subdata, <span class="at">split_measures =</span> <span class="fu">c</span>(<span class="st">"proxy_vuln"</span>),</span>
<span id="cb3-613"><a href="#cb3-613" aria-hidden="true" tabindex="-1"></a>      <span class="at">whole_pop_measures =</span> <span class="fu">c</span>(<span class="st">"risk_spread"</span>, <span class="st">"fair_range"</span>, <span class="st">"parity_cost"</span>),</span>
<span id="cb3-614"><a href="#cb3-614" aria-hidden="true" tabindex="-1"></a>      <span class="at">protected_group_col =</span> sensitive_variable</span>
<span id="cb3-615"><a href="#cb3-615" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-616"><a href="#cb3-616" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fairness Spectrum"</span> <span class="ot">=</span> <span class="cf">function</span>(subdata) <span class="fu">summarize_fairness_spectrum</span>(subdata,</span>
<span id="cb3-617"><a href="#cb3-617" aria-hidden="true" tabindex="-1"></a>                                                                        <span class="at">fairness_cols =</span> <span class="fu">c</span>(<span class="st">"mu_B"</span>, <span class="st">"mu_U"</span>, <span class="st">"mu_A"</span>, <span class="st">"mu_H"</span>, <span class="st">"mu_C"</span>),</span>
<span id="cb3-618"><a href="#cb3-618" aria-hidden="true" tabindex="-1"></a>                                                                        <span class="at">summary_functions =</span> <span class="fu">c</span>(<span class="st">'mean'</span>),</span>
<span id="cb3-619"><a href="#cb3-619" aria-hidden="true" tabindex="-1"></a>                                                                        <span class="at">spectrum_labels =</span> <span class="fu">c</span>(<span class="st">'Best-est.'</span>, <span class="st">'Unaware'</span>, <span class="st">'Aware'</span>,</span>
<span id="cb3-620"><a href="#cb3-620" aria-hidden="true" tabindex="-1"></a>                                                                                            <span class="st">'Hyperaware'</span>, <span class="st">'Corrective'</span>)),</span>
<span id="cb3-621"><a href="#cb3-621" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fairness implications of commercial price"</span> <span class="ot">=</span> <span class="cf">function</span>(subdata) <span class="fu">summarize_premium_spectrum</span>(</span>
<span id="cb3-622"><a href="#cb3-622" aria-hidden="true" tabindex="-1"></a>      subdata, <span class="at">premium_col =</span> <span class="st">"prem"</span>, <span class="at">mua_col =</span> <span class="st">"mu_A"</span>, <span class="at">mub_col =</span> <span class="st">"mu_B"</span>, <span class="at">group_col =</span> sensitive_variable, <span class="at">rank_col =</span> <span class="st">"r"</span>, <span class="at">pd =</span> marg_dist</span>
<span id="cb3-623"><a href="#cb3-623" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-624"><a href="#cb3-624" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Vulnerability"</span> <span class="ot">=</span> <span class="cf">function</span>(subdata) <span class="fu">summarize_vulnerability</span>(</span>
<span id="cb3-625"><a href="#cb3-625" aria-hidden="true" tabindex="-1"></a>      subdata, <span class="at">premium_col =</span> <span class="st">"prem"</span>, <span class="at">mua_col =</span> <span class="st">"mu_A"</span>,</span>
<span id="cb3-626"><a href="#cb3-626" aria-hidden="true" tabindex="-1"></a>      <span class="at">group_col =</span> sensitive_variable,</span>
<span id="cb3-627"><a href="#cb3-627" aria-hidden="true" tabindex="-1"></a>      <span class="at">thresholds =</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">quantile</span>((data<span class="sc">$</span>prem <span class="sc">-</span> data<span class="sc">$</span>mu_A)<span class="sc">/</span>data<span class="sc">$</span>mu_A, <span class="fu">c</span>(<span class="fl">0.65</span>, <span class="fl">0.75</span>))), <span class="dv">3</span>) )</span>
<span id="cb3-628"><a href="#cb3-628" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-629"><a href="#cb3-629" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-630"><a href="#cb3-630" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize list to hold all summaries</span></span>
<span id="cb3-631"><a href="#cb3-631" aria-hidden="true" tabindex="-1"></a>  all_summaries <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-632"><a href="#cb3-632" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-633"><a href="#cb3-633" aria-hidden="true" tabindex="-1"></a>  <span class="co"># edit group_col. build multiple table : full, full-middle, pruned</span></span>
<span id="cb3-634"><a href="#cb3-634" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-635"><a href="#cb3-635" aria-hidden="true" tabindex="-1"></a>  <span class="co">#dictionnary_leaves_trees</span></span>
<span id="cb3-636"><a href="#cb3-636" aria-hidden="true" tabindex="-1"></a>  <span class="co">#dictionnary_leaves_trees_comm</span></span>
<span id="cb3-637"><a href="#cb3-637" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-638"><a href="#cb3-638" aria-hidden="true" tabindex="-1"></a>  the_filters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">'1'</span> <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(data)),</span>
<span id="cb3-639"><a href="#cb3-639" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'proxy'</span> <span class="ot">=</span> dictionnary_proxy)</span>
<span id="cb3-640"><a href="#cb3-640" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-641"><a href="#cb3-641" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (gr <span class="cf">in</span> <span class="fu">setdiff</span>(group_col, <span class="st">'1'</span>)) {</span>
<span id="cb3-642"><a href="#cb3-642" aria-hidden="true" tabindex="-1"></a>    data[[<span class="st">'g'</span>]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(data[[gr]]))</span>
<span id="cb3-643"><a href="#cb3-643" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(data, dictionnary_proxy<span class="sc">$</span>rpart<span class="sc">$</span>dict,</span>
<span id="cb3-644"><a href="#cb3-644" aria-hidden="true" tabindex="-1"></a>                      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'g'</span> <span class="ot">=</span> <span class="st">'pred'</span>)) </span>
<span id="cb3-645"><a href="#cb3-645" aria-hidden="true" tabindex="-1"></a>    data[[<span class="fu">paste0</span>(gr, <span class="st">'_node_new'</span>)]] <span class="ot">&lt;-</span> data<span class="sc">$</span>node_new</span>
<span id="cb3-646"><a href="#cb3-646" aria-hidden="true" tabindex="-1"></a>    data[[<span class="fu">paste0</span>(gr, <span class="st">'_node_or'</span>)]] <span class="ot">&lt;-</span> data<span class="sc">$</span>node_or</span>
<span id="cb3-647"><a href="#cb3-647" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>g <span class="ot">&lt;-</span> <span class="cn">NULL</span>; data<span class="sc">$</span>node_new <span class="ot">&lt;-</span> <span class="cn">NULL</span>; data<span class="sc">$</span>node_or <span class="ot">&lt;-</span> <span class="cn">NULL</span>;</span>
<span id="cb3-648"><a href="#cb3-648" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-649"><a href="#cb3-649" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-650"><a href="#cb3-650" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-651"><a href="#cb3-651" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop over each variable in group_col</span></span>
<span id="cb3-652"><a href="#cb3-652" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (col <span class="cf">in</span> group_col) {</span>
<span id="cb3-653"><a href="#cb3-653" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (col <span class="sc">==</span> <span class="st">"1"</span>) {</span>
<span id="cb3-654"><a href="#cb3-654" aria-hidden="true" tabindex="-1"></a>      subdata <span class="ot">&lt;-</span> data</span>
<span id="cb3-655"><a href="#cb3-655" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb3-656"><a href="#cb3-656" aria-hidden="true" tabindex="-1"></a>        rbind,</span>
<span id="cb3-657"><a href="#cb3-657" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(<span class="fu">names</span>(summary_functions), <span class="cf">function</span>(section) {</span>
<span id="cb3-658"><a href="#cb3-658" aria-hidden="true" tabindex="-1"></a>          <span class="fu">add_section</span>(summary_functions[[section]](subdata), section)</span>
<span id="cb3-659"><a href="#cb3-659" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb3-660"><a href="#cb3-660" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-661"><a href="#cb3-661" aria-hidden="true" tabindex="-1"></a>      summary_table <span class="ot">&lt;-</span> summary_table <span class="sc">%&gt;%</span></span>
<span id="cb3-662"><a href="#cb3-662" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"All Data"</span>), <span class="fu">starts_with</span>(<span class="st">"Value"</span>))</span>
<span id="cb3-663"><a href="#cb3-663" aria-hidden="true" tabindex="-1"></a>      all_summaries[[<span class="st">"All Data"</span>]] <span class="ot">&lt;-</span> summary_table</span>
<span id="cb3-664"><a href="#cb3-664" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-665"><a href="#cb3-665" aria-hidden="true" tabindex="-1"></a>      levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(<span class="fu">factor</span>(data[[col]]))</span>
<span id="cb3-666"><a href="#cb3-666" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (level <span class="cf">in</span> levels) {</span>
<span id="cb3-667"><a href="#cb3-667" aria-hidden="true" tabindex="-1"></a>        subdata <span class="ot">&lt;-</span> data[data[[col]] <span class="sc">==</span> level, ]</span>
<span id="cb3-668"><a href="#cb3-668" aria-hidden="true" tabindex="-1"></a>        summary_table <span class="ot">&lt;-</span> <span class="fu">do.call</span>(</span>
<span id="cb3-669"><a href="#cb3-669" aria-hidden="true" tabindex="-1"></a>          rbind,</span>
<span id="cb3-670"><a href="#cb3-670" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lapply</span>(<span class="fu">names</span>(summary_functions), <span class="cf">function</span>(section) {</span>
<span id="cb3-671"><a href="#cb3-671" aria-hidden="true" tabindex="-1"></a>            <span class="fu">add_section</span>(summary_functions[[section]](subdata), section)</span>
<span id="cb3-672"><a href="#cb3-672" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb3-673"><a href="#cb3-673" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-674"><a href="#cb3-674" aria-hidden="true" tabindex="-1"></a>        summary_table <span class="ot">&lt;-</span> summary_table <span class="sc">%&gt;%</span></span>
<span id="cb3-675"><a href="#cb3-675" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(<span class="fu">names</span>(group_col)[<span class="fu">which</span>(group_col <span class="sc">==</span> col)], <span class="st">" - "</span>, level), <span class="fu">starts_with</span>(<span class="st">"Value"</span>))</span>
<span id="cb3-676"><a href="#cb3-676" aria-hidden="true" tabindex="-1"></a>        key <span class="ot">&lt;-</span> <span class="fu">paste0</span>(col, <span class="st">" - "</span>, level)</span>
<span id="cb3-677"><a href="#cb3-677" aria-hidden="true" tabindex="-1"></a>        all_summaries[[key]] <span class="ot">&lt;-</span> summary_table</span>
<span id="cb3-678"><a href="#cb3-678" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-679"><a href="#cb3-679" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-680"><a href="#cb3-680" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-681"><a href="#cb3-681" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-682"><a href="#cb3-682" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine summaries while preserving section order</span></span>
<span id="cb3-683"><a href="#cb3-683" aria-hidden="true" tabindex="-1"></a>  section_order <span class="ot">&lt;-</span> <span class="fu">names</span>(summary_functions)</span>
<span id="cb3-684"><a href="#cb3-684" aria-hidden="true" tabindex="-1"></a>  final_table <span class="ot">&lt;-</span> <span class="fu">Reduce</span>(<span class="cf">function</span>(x, y) dplyr<span class="sc">::</span><span class="fu">left_join</span>(x, y, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Section"</span>, <span class="st">"Variable"</span>, <span class="st">"Statistic"</span>)), all_summaries) <span class="sc">%&gt;%</span></span>
<span id="cb3-685"><a href="#cb3-685" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Section =</span> <span class="fu">factor</span>(Section, <span class="at">levels =</span> section_order)) <span class="sc">%&gt;%</span>  <span class="co"># Enforce order</span></span>
<span id="cb3-686"><a href="#cb3-686" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(Section)  <span class="co"># Sort by Section</span></span>
<span id="cb3-687"><a href="#cb3-687" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-688"><a href="#cb3-688" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure column order</span></span>
<span id="cb3-689"><a href="#cb3-689" aria-hidden="true" tabindex="-1"></a>  ordered_col_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Section"</span>, <span class="st">"Variable"</span>, <span class="st">"Statistic"</span>, <span class="fu">setdiff</span>(<span class="fu">names</span>(final_table), <span class="fu">c</span>(<span class="st">"Section"</span>, <span class="st">"Variable"</span>, <span class="st">"Statistic"</span>)))</span>
<span id="cb3-690"><a href="#cb3-690" aria-hidden="true" tabindex="-1"></a>  final_table <span class="ot">&lt;-</span> final_table[, ordered_col_names]</span>
<span id="cb3-691"><a href="#cb3-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final_table)</span>
<span id="cb3-692"><a href="#cb3-692" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-693"><a href="#cb3-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-694"><a href="#cb3-694" aria-hidden="true" tabindex="-1"></a>summarize_fairness_groups <span class="ot">&lt;-</span> <span class="cf">function</span>(data, </span>
<span id="cb3-695"><a href="#cb3-695" aria-hidden="true" tabindex="-1"></a>                                      group_col,</span>
<span id="cb3-696"><a href="#cb3-696" aria-hidden="true" tabindex="-1"></a>                                      marg_dist,</span>
<span id="cb3-697"><a href="#cb3-697" aria-hidden="true" tabindex="-1"></a>                                      sensitive_variable,</span>
<span id="cb3-698"><a href="#cb3-698" aria-hidden="true" tabindex="-1"></a>                                      dictionnary_proxy,</span>
<span id="cb3-699"><a href="#cb3-699" aria-hidden="true" tabindex="-1"></a>                                      dictionnary_comm,</span>
<span id="cb3-700"><a href="#cb3-700" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">demographics_variables =</span> <span class="fu">c</span>(<span class="st">"D"</span>, <span class="st">"X2"</span>, <span class="st">"X1"</span>)) {</span>
<span id="cb3-701"><a href="#cb3-701" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-702"><a href="#cb3-702" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define a helper function to process each group type</span></span>
<span id="cb3-703"><a href="#cb3-703" aria-hidden="true" tabindex="-1"></a>  process_group <span class="ot">&lt;-</span> <span class="cf">function</span>(data, group_type, dict_proxy, dict_comm) {</span>
<span id="cb3-704"><a href="#cb3-704" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map proxy vulnerable groups</span></span>
<span id="cb3-705"><a href="#cb3-705" aria-hidden="true" tabindex="-1"></a>    data[[<span class="fu">paste0</span>(<span class="st">"pg_"</span>, group_type)]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb3-706"><a href="#cb3-706" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(dict_proxy<span class="sc">$</span>model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">'node'</span>) <span class="sc">%&gt;%</span> unname,</span>
<span id="cb3-707"><a href="#cb3-707" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> dict_proxy<span class="sc">$</span>dict<span class="sc">$</span>node_or,</span>
<span id="cb3-708"><a href="#cb3-708" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> dict_proxy<span class="sc">$</span>dict<span class="sc">$</span>node_new</span>
<span id="cb3-709"><a href="#cb3-709" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-710"><a href="#cb3-710" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-711"><a href="#cb3-711" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Regroup proxy groups if needed</span></span>
<span id="cb3-712"><a href="#cb3-712" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (group_type <span class="sc">==</span> <span class="st">"regrouped"</span>) {</span>
<span id="cb3-713"><a href="#cb3-713" aria-hidden="true" tabindex="-1"></a>      <span class="fu">levels</span>(data[[<span class="fu">paste0</span>(<span class="st">"pg_"</span>, group_type)]]) <span class="ot">&lt;-</span> <span class="fu">recode_bottom_top_middle</span>(<span class="fu">levels</span>(data[[<span class="fu">paste0</span>(<span class="st">"pg_"</span>, group_type)]]))</span>
<span id="cb3-714"><a href="#cb3-714" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-715"><a href="#cb3-715" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-716"><a href="#cb3-716" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map commercially loaded groups</span></span>
<span id="cb3-717"><a href="#cb3-717" aria-hidden="true" tabindex="-1"></a>    data[[<span class="fu">paste0</span>(<span class="st">"cg_"</span>, group_type)]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb3-718"><a href="#cb3-718" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(dict_comm<span class="sc">$</span>model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">'node'</span>) <span class="sc">%&gt;%</span> unname,</span>
<span id="cb3-719"><a href="#cb3-719" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> dict_comm<span class="sc">$</span>dict<span class="sc">$</span>node_or,</span>
<span id="cb3-720"><a href="#cb3-720" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> dict_comm<span class="sc">$</span>dict<span class="sc">$</span>node_new</span>
<span id="cb3-721"><a href="#cb3-721" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-722"><a href="#cb3-722" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-723"><a href="#cb3-723" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Regroup commercial groups if needed</span></span>
<span id="cb3-724"><a href="#cb3-724" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (group_type <span class="sc">==</span> <span class="st">"regrouped"</span>) {</span>
<span id="cb3-725"><a href="#cb3-725" aria-hidden="true" tabindex="-1"></a>      <span class="fu">levels</span>(data[[<span class="fu">paste0</span>(<span class="st">"cg_"</span>, group_type)]]) <span class="ot">&lt;-</span> <span class="fu">recode_bottom_top_middle</span>(<span class="fu">levels</span>(data[[<span class="fu">paste0</span>(<span class="st">"cg_"</span>, group_type)]]))</span>
<span id="cb3-726"><a href="#cb3-726" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-727"><a href="#cb3-727" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-728"><a href="#cb3-728" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate the fairness summary table</span></span>
<span id="cb3-729"><a href="#cb3-729" aria-hidden="true" tabindex="-1"></a>    group_col <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb3-730"><a href="#cb3-730" aria-hidden="true" tabindex="-1"></a>      <span class="st">"All data"</span> <span class="ot">=</span> <span class="st">"1"</span>,</span>
<span id="cb3-731"><a href="#cb3-731" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Proxy vulnerable groups"</span> <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"pg_"</span>, group_type),</span>
<span id="cb3-732"><a href="#cb3-732" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Commercially loaded groups"</span> <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"cg_"</span>, group_type)</span>
<span id="cb3-733"><a href="#cb3-733" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-734"><a href="#cb3-734" aria-hidden="true" tabindex="-1"></a>    big_tab <span class="ot">&lt;-</span> <span class="fu">summarize_fairness_table</span>(</span>
<span id="cb3-735"><a href="#cb3-735" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> data,</span>
<span id="cb3-736"><a href="#cb3-736" aria-hidden="true" tabindex="-1"></a>      <span class="at">group_col =</span> group_col,</span>
<span id="cb3-737"><a href="#cb3-737" aria-hidden="true" tabindex="-1"></a>      <span class="at">sensitive_variable =</span> sensitive_variable,</span>
<span id="cb3-738"><a href="#cb3-738" aria-hidden="true" tabindex="-1"></a>      <span class="at">marg_dist =</span> marg_dist</span>
<span id="cb3-739"><a href="#cb3-739" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-740"><a href="#cb3-740" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-741"><a href="#cb3-741" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a row for "Leaf composition"</span></span>
<span id="cb3-742"><a href="#cb3-742" aria-hidden="true" tabindex="-1"></a>    to_add_to_big_tab_full <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">ncol</span>(big_tab))</span>
<span id="cb3-743"><a href="#cb3-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(to_add_to_big_tab_full) <span class="ot">&lt;-</span> <span class="fu">names</span>(big_tab)</span>
<span id="cb3-744"><a href="#cb3-744" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-745"><a href="#cb3-745" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the node labels for proxy and commercial groups</span></span>
<span id="cb3-746"><a href="#cb3-746" aria-hidden="true" tabindex="-1"></a>    the_nms_p <span class="ot">&lt;-</span> <span class="fu">names</span>(big_tab)[<span class="fu">grepl</span>(<span class="fu">names</span>(group_col[<span class="dv">2</span>]), <span class="fu">names</span>(big_tab))]</span>
<span id="cb3-747"><a href="#cb3-747" aria-hidden="true" tabindex="-1"></a>    the_nms_c <span class="ot">&lt;-</span> <span class="fu">names</span>(big_tab)[<span class="fu">grepl</span>(<span class="fu">names</span>(group_col[<span class="dv">3</span>]), <span class="fu">names</span>(big_tab))]</span>
<span id="cb3-748"><a href="#cb3-748" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-749"><a href="#cb3-749" aria-hidden="true" tabindex="-1"></a>    the_nodes_new_p <span class="ot">&lt;-</span> <span class="fu">str_split</span>(the_nms_p, <span class="st">"-"</span>, <span class="at">n =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-750"><a href="#cb3-750" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(<span class="cf">function</span>(pieces) pieces[<span class="dv">2</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb3-751"><a href="#cb3-751" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>()</span>
<span id="cb3-752"><a href="#cb3-752" aria-hidden="true" tabindex="-1"></a>    the_nodes_new_c <span class="ot">&lt;-</span> <span class="fu">str_split</span>(the_nms_c, <span class="st">"-"</span>, <span class="at">n =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-753"><a href="#cb3-753" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lapply</span>(<span class="cf">function</span>(pieces) pieces[<span class="dv">2</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb3-754"><a href="#cb3-754" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>()</span>
<span id="cb3-755"><a href="#cb3-755" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-756"><a href="#cb3-756" aria-hidden="true" tabindex="-1"></a>    the_nodes_or_p <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">as.numeric</span>(the_nodes_new_p), <span class="cf">function</span>(node_new_id) {</span>
<span id="cb3-757"><a href="#cb3-757" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.na</span>(node_new_id)) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb3-758"><a href="#cb3-758" aria-hidden="true" tabindex="-1"></a>      dict_proxy<span class="sc">$</span>dict <span class="sc">%&gt;%</span> <span class="fu">filter</span>(node_new <span class="sc">==</span> node_new_id) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(node_or)</span>
<span id="cb3-759"><a href="#cb3-759" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb3-760"><a href="#cb3-760" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-761"><a href="#cb3-761" aria-hidden="true" tabindex="-1"></a>    the_nodes_or_c <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">as.numeric</span>(the_nodes_new_c), <span class="cf">function</span>(node_new_id) {</span>
<span id="cb3-762"><a href="#cb3-762" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.na</span>(node_new_id)) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb3-763"><a href="#cb3-763" aria-hidden="true" tabindex="-1"></a>      dict_comm<span class="sc">$</span>dict <span class="sc">%&gt;%</span> <span class="fu">filter</span>(node_new <span class="sc">==</span> node_new_id) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(node_or)</span>
<span id="cb3-764"><a href="#cb3-764" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb3-765"><a href="#cb3-765" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-766"><a href="#cb3-766" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simplify paths for nodes</span></span>
<span id="cb3-767"><a href="#cb3-767" aria-hidden="true" tabindex="-1"></a>    the_nodes_path_simp_p <span class="ot">&lt;-</span> <span class="fu">sapply</span>(the_nodes_or_p, <span class="cf">function</span>(node_or) {</span>
<span id="cb3-768"><a href="#cb3-768" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.na</span>(node_or)) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb3-769"><a href="#cb3-769" aria-hidden="true" tabindex="-1"></a>      dict_proxy<span class="sc">$</span>paths<span class="sc">$</span>simp_concat[[<span class="fu">as.character</span>(node_or)]]</span>
<span id="cb3-770"><a href="#cb3-770" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-771"><a href="#cb3-771" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-772"><a href="#cb3-772" aria-hidden="true" tabindex="-1"></a>    the_nodes_path_simp_c <span class="ot">&lt;-</span> <span class="fu">sapply</span>(the_nodes_or_c, <span class="cf">function</span>(node_or) {</span>
<span id="cb3-773"><a href="#cb3-773" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.na</span>(node_or)) <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb3-774"><a href="#cb3-774" aria-hidden="true" tabindex="-1"></a>      dict_comm<span class="sc">$</span>paths<span class="sc">$</span>simp_concat[[<span class="fu">as.character</span>(node_or)]]</span>
<span id="cb3-775"><a href="#cb3-775" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-776"><a href="#cb3-776" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-777"><a href="#cb3-777" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add paths to the final row of the summary table</span></span>
<span id="cb3-778"><a href="#cb3-778" aria-hidden="true" tabindex="-1"></a>    to_add_to_big_tab_full[the_nms_p] <span class="ot">&lt;-</span> the_nodes_path_simp_p</span>
<span id="cb3-779"><a href="#cb3-779" aria-hidden="true" tabindex="-1"></a>    to_add_to_big_tab_full[the_nms_c] <span class="ot">&lt;-</span> the_nodes_path_simp_c</span>
<span id="cb3-780"><a href="#cb3-780" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-781"><a href="#cb3-781" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">'table'</span> <span class="ot">=</span> big_tab,</span>
<span id="cb3-782"><a href="#cb3-782" aria-hidden="true" tabindex="-1"></a>                <span class="st">'paths'</span> <span class="ot">=</span> to_add_to_big_tab_full))</span>
<span id="cb3-783"><a href="#cb3-783" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-784"><a href="#cb3-784" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-785"><a href="#cb3-785" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process each group type</span></span>
<span id="cb3-786"><a href="#cb3-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>({</span>
<span id="cb3-787"><a href="#cb3-787" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressMessages</span>({</span>
<span id="cb3-788"><a href="#cb3-788" aria-hidden="true" tabindex="-1"></a>      big_tab_f_full <span class="ot">&lt;-</span><span class="fu">process_group</span>(data, <span class="st">"full"</span>,</span>
<span id="cb3-789"><a href="#cb3-789" aria-hidden="true" tabindex="-1"></a>                                     dictionnary_proxy<span class="sc">$</span>rpart,</span>
<span id="cb3-790"><a href="#cb3-790" aria-hidden="true" tabindex="-1"></a>                                     dictionnary_comm<span class="sc">$</span>rpart)</span>
<span id="cb3-791"><a href="#cb3-791" aria-hidden="true" tabindex="-1"></a>      big_tab_r_full <span class="ot">&lt;-</span> <span class="fu">process_group</span>(data, <span class="st">"regrouped"</span>,</span>
<span id="cb3-792"><a href="#cb3-792" aria-hidden="true" tabindex="-1"></a>                                      dictionnary_proxy<span class="sc">$</span>rpart,</span>
<span id="cb3-793"><a href="#cb3-793" aria-hidden="true" tabindex="-1"></a>                                      dictionnary_comm<span class="sc">$</span>rpart)</span>
<span id="cb3-794"><a href="#cb3-794" aria-hidden="true" tabindex="-1"></a>      big_tab_p_full <span class="ot">&lt;-</span> <span class="fu">process_group</span>(data, <span class="st">"pruned"</span>, </span>
<span id="cb3-795"><a href="#cb3-795" aria-hidden="true" tabindex="-1"></a>                                      dictionnary_proxy<span class="sc">$</span>rpart_prune,</span>
<span id="cb3-796"><a href="#cb3-796" aria-hidden="true" tabindex="-1"></a>                                      dictionnary_comm<span class="sc">$</span>rpart_prune) </span>
<span id="cb3-797"><a href="#cb3-797" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-798"><a href="#cb3-798" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-799"><a href="#cb3-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-800"><a href="#cb3-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-801"><a href="#cb3-801" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-802"><a href="#cb3-802" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return all three summary tables in a list</span></span>
<span id="cb3-803"><a href="#cb3-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb3-804"><a href="#cb3-804" aria-hidden="true" tabindex="-1"></a>    <span class="st">"All subgroups"</span> <span class="ot">=</span> big_tab_f_full,</span>
<span id="cb3-805"><a href="#cb3-805" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Top-Bottom subgroups"</span> <span class="ot">=</span> big_tab_r_full,</span>
<span id="cb3-806"><a href="#cb3-806" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coarse groups"</span> <span class="ot">=</span> big_tab_p_full</span>
<span id="cb3-807"><a href="#cb3-807" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb3-808"><a href="#cb3-808" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-809"><a href="#cb3-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-810"><a href="#cb3-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-811"><a href="#cb3-811" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(openxlsx)</span>
<span id="cb3-812"><a href="#cb3-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-813"><a href="#cb3-813" aria-hidden="true" tabindex="-1"></a>export_to_excel <span class="ot">&lt;-</span> <span class="cf">function</span>(summary_tables,</span>
<span id="cb3-814"><a href="#cb3-814" aria-hidden="true" tabindex="-1"></a>                            <span class="at">file_name =</span> <span class="st">"summary.xlsx"</span>) {</span>
<span id="cb3-815"><a href="#cb3-815" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-816"><a href="#cb3-816" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a new workbook</span></span>
<span id="cb3-817"><a href="#cb3-817" aria-hidden="true" tabindex="-1"></a>  wb <span class="ot">&lt;-</span> <span class="fu">createWorkbook</span>()</span>
<span id="cb3-818"><a href="#cb3-818" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-819"><a href="#cb3-819" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(summary_tables)) {</span>
<span id="cb3-820"><a href="#cb3-820" aria-hidden="true" tabindex="-1"></a>    summary_table <span class="ot">&lt;-</span> summary_tables[[i]]<span class="sc">$</span>table</span>
<span id="cb3-821"><a href="#cb3-821" aria-hidden="true" tabindex="-1"></a>    sheet_name <span class="ot">&lt;-</span> <span class="fu">names</span>(summary_tables)[i]</span>
<span id="cb3-822"><a href="#cb3-822" aria-hidden="true" tabindex="-1"></a>    to_add <span class="ot">&lt;-</span> summary_tables[[i]]<span class="sc">$</span>paths</span>
<span id="cb3-823"><a href="#cb3-823" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-824"><a href="#cb3-824" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure sheet name is a valid character</span></span>
<span id="cb3-825"><a href="#cb3-825" aria-hidden="true" tabindex="-1"></a>    sheet_name <span class="ot">&lt;-</span> <span class="fu">enc2native</span>(<span class="fu">as.character</span>(sheet_name))</span>
<span id="cb3-826"><a href="#cb3-826" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-827"><a href="#cb3-827" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure all column names in the workbook are properly encoded</span></span>
<span id="cb3-828"><a href="#cb3-828" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(summary_table) <span class="ot">&lt;-</span> <span class="fu">enc2native</span>(<span class="fu">as.character</span>(<span class="fu">colnames</span>(summary_table)))</span>
<span id="cb3-829"><a href="#cb3-829" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-830"><a href="#cb3-830" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a worksheet</span></span>
<span id="cb3-831"><a href="#cb3-831" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addWorksheet</span>(wb, sheet_name)</span>
<span id="cb3-832"><a href="#cb3-832" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-833"><a href="#cb3-833" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract column names and split into groups and labels</span></span>
<span id="cb3-834"><a href="#cb3-834" aria-hidden="true" tabindex="-1"></a>    original_colnames <span class="ot">&lt;-</span> <span class="fu">colnames</span>(summary_table)</span>
<span id="cb3-835"><a href="#cb3-835" aria-hidden="true" tabindex="-1"></a>    split_names <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(original_colnames, <span class="st">" - "</span>, <span class="at">fixed =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-836"><a href="#cb3-836" aria-hidden="true" tabindex="-1"></a>    groups <span class="ot">&lt;-</span> <span class="fu">sapply</span>(split_names, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">length</span>(x) <span class="sc">&gt;</span> <span class="dv">1</span>, x[<span class="dv">1</span>], <span class="st">""</span>))  <span class="co"># Left part</span></span>
<span id="cb3-837"><a href="#cb3-837" aria-hidden="true" tabindex="-1"></a>    labels <span class="ot">&lt;-</span> <span class="fu">sapply</span>(split_names, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">length</span>(x) <span class="sc">&gt;</span> <span class="dv">1</span>, x[<span class="dv">2</span>], x[<span class="dv">1</span>]))  <span class="co"># Right part</span></span>
<span id="cb3-838"><a href="#cb3-838" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-839"><a href="#cb3-839" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the second header row (labels)</span></span>
<span id="cb3-840"><a href="#cb3-840" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeData</span>(wb, sheet_name, <span class="fu">t</span>(labels), <span class="at">startRow =</span> <span class="dv">2</span>, <span class="at">colNames =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-841"><a href="#cb3-841" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-842"><a href="#cb3-842" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the first header row (groups) and merge cells for groups</span></span>
<span id="cb3-843"><a href="#cb3-843" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (group <span class="cf">in</span> <span class="fu">unique</span>(groups)) {</span>
<span id="cb3-844"><a href="#cb3-844" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (group <span class="sc">!=</span> <span class="st">""</span>) {</span>
<span id="cb3-845"><a href="#cb3-845" aria-hidden="true" tabindex="-1"></a>        matching_cols <span class="ot">&lt;-</span> <span class="fu">which</span>(groups <span class="sc">==</span> group)  <span class="co"># Columns in the same group</span></span>
<span id="cb3-846"><a href="#cb3-846" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mergeCells</span>(wb, sheet_name, <span class="at">cols =</span> matching_cols, <span class="at">rows =</span> <span class="dv">1</span>)  <span class="co"># Merge cells for the group</span></span>
<span id="cb3-847"><a href="#cb3-847" aria-hidden="true" tabindex="-1"></a>        <span class="fu">writeData</span>(wb, sheet_name, group, <span class="at">startCol =</span> <span class="fu">min</span>(matching_cols),</span>
<span id="cb3-848"><a href="#cb3-848" aria-hidden="true" tabindex="-1"></a>                  <span class="at">startRow =</span> <span class="dv">1</span>, <span class="at">colNames =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-849"><a href="#cb3-849" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-850"><a href="#cb3-850" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-851"><a href="#cb3-851" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-852"><a href="#cb3-852" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the main data below the headers</span></span>
<span id="cb3-853"><a href="#cb3-853" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeData</span>(wb, sheet_name, summary_table, <span class="at">startRow =</span> <span class="dv">3</span>, <span class="at">colNames =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-854"><a href="#cb3-854" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-855"><a href="#cb3-855" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-856"><a href="#cb3-856" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply a new theme for the headers</span></span>
<span id="cb3-857"><a href="#cb3-857" aria-hidden="true" tabindex="-1"></a>    header_style_1 <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(</span>
<span id="cb3-858"><a href="#cb3-858" aria-hidden="true" tabindex="-1"></a>      <span class="at">fontSize =</span> <span class="dv">14</span>, <span class="at">fontColour =</span> the_CAS_colors_full[<span class="dv">6</span>], <span class="at">fgFill =</span> the_CAS_colors_full[<span class="dv">4</span>], </span>
<span id="cb3-859"><a href="#cb3-859" aria-hidden="true" tabindex="-1"></a>      <span class="at">halign =</span> <span class="st">"CENTER"</span>, <span class="at">textDecoration =</span> <span class="st">"Bold"</span>, <span class="at">border =</span> <span class="st">"Bottom"</span>, <span class="at">borderColour =</span> <span class="st">"black"</span>, <span class="at">borderStyle =</span> <span class="st">"thick"</span></span>
<span id="cb3-860"><a href="#cb3-860" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-861"><a href="#cb3-861" aria-hidden="true" tabindex="-1"></a>    header_style_2 <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(</span>
<span id="cb3-862"><a href="#cb3-862" aria-hidden="true" tabindex="-1"></a>      <span class="at">fontSize =</span> <span class="dv">12</span>, <span class="at">fontColour =</span> the_CAS_colors_full[<span class="dv">6</span>], <span class="at">fgFill =</span> the_CAS_colors_full[<span class="dv">4</span>], </span>
<span id="cb3-863"><a href="#cb3-863" aria-hidden="true" tabindex="-1"></a>      <span class="at">halign =</span> <span class="st">"CENTER"</span>, <span class="at">textDecoration =</span> <span class="st">"Bold"</span></span>
<span id="cb3-864"><a href="#cb3-864" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-865"><a href="#cb3-865" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addStyle</span>(wb, sheet_name, <span class="at">style =</span> header_style_1, <span class="at">rows =</span> <span class="dv">1</span>, <span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table), <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-866"><a href="#cb3-866" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addStyle</span>(wb, sheet_name, <span class="at">style =</span> header_style_2, <span class="at">rows =</span> <span class="dv">2</span>, <span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table), <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-867"><a href="#cb3-867" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-868"><a href="#cb3-868" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge vertically consecutive cells in the first two columns</span></span>
<span id="cb3-869"><a href="#cb3-869" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) {  <span class="co"># Only for Section and Variable columns</span></span>
<span id="cb3-870"><a href="#cb3-870" aria-hidden="true" tabindex="-1"></a>      values <span class="ot">&lt;-</span> summary_table[[col]]</span>
<span id="cb3-871"><a href="#cb3-871" aria-hidden="true" tabindex="-1"></a>      start_row <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># Data starts at row 3</span></span>
<span id="cb3-872"><a href="#cb3-872" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(values)) {</span>
<span id="cb3-873"><a href="#cb3-873" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span> <span class="sc">||</span> values[i] <span class="sc">!=</span> values[i <span class="sc">-</span> <span class="dv">1</span>]) {</span>
<span id="cb3-874"><a href="#cb3-874" aria-hidden="true" tabindex="-1"></a>          start_merge <span class="ot">&lt;-</span> start_row <span class="sc">+</span> i <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb3-875"><a href="#cb3-875" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-876"><a href="#cb3-876" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i <span class="sc">==</span> <span class="fu">length</span>(values) <span class="sc">||</span> values[i] <span class="sc">!=</span> values[i <span class="sc">+</span> <span class="dv">1</span>]) {</span>
<span id="cb3-877"><a href="#cb3-877" aria-hidden="true" tabindex="-1"></a>          end_merge <span class="ot">&lt;-</span> start_row <span class="sc">+</span> i <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb3-878"><a href="#cb3-878" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mergeCells</span>(wb, sheet_name, <span class="at">cols =</span> col, <span class="at">rows =</span> start_merge<span class="sc">:</span>end_merge)</span>
<span id="cb3-879"><a href="#cb3-879" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-880"><a href="#cb3-880" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-881"><a href="#cb3-881" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-882"><a href="#cb3-882" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-883"><a href="#cb3-883" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply vertical alignment and rotation styles to the first two columns</span></span>
<span id="cb3-884"><a href="#cb3-884" aria-hidden="true" tabindex="-1"></a>    vertical_align_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(<span class="at">halign =</span> <span class="st">"CENTER"</span>, <span class="at">valign =</span> <span class="st">"CENTER"</span>, </span>
<span id="cb3-885"><a href="#cb3-885" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">wrapText =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-886"><a href="#cb3-886" aria-hidden="true" tabindex="-1"></a>    rotated_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(</span>
<span id="cb3-887"><a href="#cb3-887" aria-hidden="true" tabindex="-1"></a>      <span class="at">textRotation =</span> <span class="dv">90</span>, </span>
<span id="cb3-888"><a href="#cb3-888" aria-hidden="true" tabindex="-1"></a>      <span class="at">halign =</span> <span class="st">"CENTER"</span>, </span>
<span id="cb3-889"><a href="#cb3-889" aria-hidden="true" tabindex="-1"></a>      <span class="at">valign =</span> <span class="st">"CENTER"</span>, </span>
<span id="cb3-890"><a href="#cb3-890" aria-hidden="true" tabindex="-1"></a>      <span class="at">wrapText =</span> <span class="cn">TRUE</span></span>
<span id="cb3-891"><a href="#cb3-891" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-892"><a href="#cb3-892" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply rotation to the first column (Section)</span></span>
<span id="cb3-893"><a href="#cb3-893" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addStyle</span>(wb, sheet_name, <span class="at">style =</span> rotated_style, <span class="at">rows =</span> <span class="dv">3</span><span class="sc">:</span>(<span class="fu">nrow</span>(summary_table) <span class="sc">+</span> <span class="dv">2</span>), <span class="at">cols =</span> <span class="dv">1</span>, <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-894"><a href="#cb3-894" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply vertical alignment to the second column (Variable)</span></span>
<span id="cb3-895"><a href="#cb3-895" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addStyle</span>(wb, sheet_name, <span class="at">style =</span> vertical_align_style, <span class="at">rows =</span> <span class="dv">3</span><span class="sc">:</span>(<span class="fu">nrow</span>(summary_table) <span class="sc">+</span> <span class="dv">2</span>), <span class="at">cols =</span> <span class="dv">2</span>, <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-896"><a href="#cb3-896" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-897"><a href="#cb3-897" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add alternating row colors based on blocks of the 'Variable' column</span></span>
<span id="cb3-898"><a href="#cb3-898" aria-hidden="true" tabindex="-1"></a>    variable_groups <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">as.character</span>(summary_table<span class="sc">$</span>Variable))  <span class="co"># Group consecutive 'Variable' values</span></span>
<span id="cb3-899"><a href="#cb3-899" aria-hidden="true" tabindex="-1"></a>    start_row <span class="ot">&lt;-</span> <span class="dv">3</span>  <span class="co"># Data starts at row 3</span></span>
<span id="cb3-900"><a href="#cb3-900" aria-hidden="true" tabindex="-1"></a>    group_starts <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">c</span>(start_row, <span class="fu">head</span>(variable_groups<span class="sc">$</span>lengths, <span class="sc">-</span><span class="dv">1</span>)))</span>
<span id="cb3-901"><a href="#cb3-901" aria-hidden="true" tabindex="-1"></a>    group_ends <span class="ot">&lt;-</span> group_starts <span class="sc">+</span> variable_groups<span class="sc">$</span>lengths <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb3-902"><a href="#cb3-902" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-903"><a href="#cb3-903" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply alternating styles to blocks</span></span>
<span id="cb3-904"><a href="#cb3-904" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(group_starts)) {</span>
<span id="cb3-905"><a href="#cb3-905" aria-hidden="true" tabindex="-1"></a>      group_rows <span class="ot">&lt;-</span> group_starts[i]<span class="sc">:</span>group_ends[i]</span>
<span id="cb3-906"><a href="#cb3-906" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>) {  <span class="co"># Alternate colors</span></span>
<span id="cb3-907"><a href="#cb3-907" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addStyle</span>(</span>
<span id="cb3-908"><a href="#cb3-908" aria-hidden="true" tabindex="-1"></a>          wb, sheet_name, </span>
<span id="cb3-909"><a href="#cb3-909" aria-hidden="true" tabindex="-1"></a>          <span class="at">style =</span> <span class="fu">createStyle</span>(<span class="at">fgFill =</span> <span class="st">"grey85"</span>),  <span class="co"># Light gray for even groups</span></span>
<span id="cb3-910"><a href="#cb3-910" aria-hidden="true" tabindex="-1"></a>          <span class="at">rows =</span> group_rows, </span>
<span id="cb3-911"><a href="#cb3-911" aria-hidden="true" tabindex="-1"></a>          <span class="at">cols =</span> <span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table), </span>
<span id="cb3-912"><a href="#cb3-912" aria-hidden="true" tabindex="-1"></a>          <span class="at">gridExpand =</span> <span class="cn">TRUE</span></span>
<span id="cb3-913"><a href="#cb3-913" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-914"><a href="#cb3-914" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb3-915"><a href="#cb3-915" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addStyle</span>(</span>
<span id="cb3-916"><a href="#cb3-916" aria-hidden="true" tabindex="-1"></a>          wb, sheet_name, </span>
<span id="cb3-917"><a href="#cb3-917" aria-hidden="true" tabindex="-1"></a>          <span class="at">style =</span> <span class="fu">createStyle</span>(<span class="at">fgFill =</span> <span class="st">"white"</span>),  <span class="co"># Light gray for even groups</span></span>
<span id="cb3-918"><a href="#cb3-918" aria-hidden="true" tabindex="-1"></a>          <span class="at">rows =</span> group_rows, </span>
<span id="cb3-919"><a href="#cb3-919" aria-hidden="true" tabindex="-1"></a>          <span class="at">cols =</span> <span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table), </span>
<span id="cb3-920"><a href="#cb3-920" aria-hidden="true" tabindex="-1"></a>          <span class="at">gridExpand =</span> <span class="cn">TRUE</span></span>
<span id="cb3-921"><a href="#cb3-921" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-922"><a href="#cb3-922" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-923"><a href="#cb3-923" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-924"><a href="#cb3-924" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-925"><a href="#cb3-925" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add vertical borders for column groups</span></span>
<span id="cb3-926"><a href="#cb3-926" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (group <span class="cf">in</span> <span class="fu">unique</span>(groups)) {</span>
<span id="cb3-927"><a href="#cb3-927" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (group <span class="sc">!=</span> <span class="st">""</span>) {</span>
<span id="cb3-928"><a href="#cb3-928" aria-hidden="true" tabindex="-1"></a>        matching_cols <span class="ot">&lt;-</span> <span class="fu">which</span>(groups <span class="sc">==</span> group)</span>
<span id="cb3-929"><a href="#cb3-929" aria-hidden="true" tabindex="-1"></a>        left_border_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(<span class="at">border =</span> <span class="st">"Left"</span>, <span class="at">borderColour =</span> <span class="st">"black"</span>, <span class="at">borderStyle =</span> <span class="st">"thick"</span>)</span>
<span id="cb3-930"><a href="#cb3-930" aria-hidden="true" tabindex="-1"></a>        right_border_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(<span class="at">border =</span> <span class="st">"Right"</span>, <span class="at">borderColour =</span> <span class="st">"black"</span>, <span class="at">borderStyle =</span> <span class="st">"thick"</span>)</span>
<span id="cb3-931"><a href="#cb3-931" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addStyle</span>(wb, sheet_name, <span class="at">style =</span> left_border_style, <span class="at">rows =</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(summary_table) <span class="sc">+</span> <span class="dv">2</span>), <span class="at">cols =</span> <span class="fu">min</span>(matching_cols), <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-932"><a href="#cb3-932" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addStyle</span>(wb, sheet_name, <span class="at">style =</span> right_border_style, <span class="at">rows =</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(summary_table) <span class="sc">+</span> <span class="dv">2</span>), <span class="at">cols =</span> <span class="fu">max</span>(matching_cols), <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-933"><a href="#cb3-933" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-934"><a href="#cb3-934" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-935"><a href="#cb3-935" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-936"><a href="#cb3-936" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add bold horizontal lines after groups of rows (based on the `Section` column)</span></span>
<span id="cb3-937"><a href="#cb3-937" aria-hidden="true" tabindex="-1"></a>    unique_sections <span class="ot">&lt;-</span> <span class="fu">unique</span>(summary_table<span class="sc">$</span>Section)</span>
<span id="cb3-938"><a href="#cb3-938" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (section <span class="cf">in</span> unique_sections) {</span>
<span id="cb3-939"><a href="#cb3-939" aria-hidden="true" tabindex="-1"></a>      group_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(summary_table<span class="sc">$</span>Section <span class="sc">==</span> section) <span class="sc">+</span> <span class="dv">2</span>  <span class="co"># Offset for header rows</span></span>
<span id="cb3-940"><a href="#cb3-940" aria-hidden="true" tabindex="-1"></a>      last_row <span class="ot">&lt;-</span> <span class="fu">max</span>(group_rows)</span>
<span id="cb3-941"><a href="#cb3-941" aria-hidden="true" tabindex="-1"></a>      horizontal_line_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(<span class="at">border =</span> <span class="st">"Bottom"</span>, <span class="at">borderColour =</span> <span class="st">"black"</span>, <span class="at">borderStyle =</span> <span class="st">"thick"</span>)</span>
<span id="cb3-942"><a href="#cb3-942" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addStyle</span>(wb, sheet_name, <span class="at">style =</span> horizontal_line_style, <span class="at">rows =</span> last_row, <span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table), <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-943"><a href="#cb3-943" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-944"><a href="#cb3-944" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-945"><a href="#cb3-945" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply number formatting for numeric columns (round to 2 decimal places for display)</span></span>
<span id="cb3-946"><a href="#cb3-946" aria-hidden="true" tabindex="-1"></a>    numeric_cols <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">sapply</span>(summary_table, is.numeric))  <span class="co"># Identify numeric columns</span></span>
<span id="cb3-947"><a href="#cb3-947" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(numeric_cols) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-948"><a href="#cb3-948" aria-hidden="true" tabindex="-1"></a>      number_format_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(<span class="at">numFmt =</span> <span class="st">"0.00"</span>)</span>
<span id="cb3-949"><a href="#cb3-949" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addStyle</span>(wb, sheet_name, <span class="at">style =</span> number_format_style, <span class="at">rows =</span> <span class="dv">3</span><span class="sc">:</span>(<span class="fu">nrow</span>(summary_table) <span class="sc">+</span> <span class="dv">2</span>), <span class="at">cols =</span> numeric_cols, <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-950"><a href="#cb3-950" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-951"><a href="#cb3-951" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-952"><a href="#cb3-952" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply 2-digit number formatting for 'Fairness Spectrum' rows</span></span>
<span id="cb3-953"><a href="#cb3-953" aria-hidden="true" tabindex="-1"></a>    pct_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">'%'</span>, summary_table<span class="sc">$</span>Variable) <span class="sc">|</span> <span class="fu">grepl</span>(<span class="st">'%'</span>, summary_table<span class="sc">$</span>Statistic)) <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb3-954"><a href="#cb3-954" aria-hidden="true" tabindex="-1"></a>    integer_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">'Observations'</span>, summary_table<span class="sc">$</span>Variable)) <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb3-955"><a href="#cb3-955" aria-hidden="true" tabindex="-1"></a>    digits3_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">'Loss Ratio'</span>, summary_table<span class="sc">$</span>Variable) <span class="sc">|</span> <span class="fu">grepl</span>(<span class="st">'Wasserstein'</span>, summary_table<span class="sc">$</span>Variable)) <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb3-956"><a href="#cb3-956" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-957"><a href="#cb3-957" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define styles for formatting</span></span>
<span id="cb3-958"><a href="#cb3-958" aria-hidden="true" tabindex="-1"></a>    pct_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(<span class="at">numFmt =</span> <span class="st">"0.00%"</span>)           <span class="co"># Percentage with 2 decimal places</span></span>
<span id="cb3-959"><a href="#cb3-959" aria-hidden="true" tabindex="-1"></a>    integer_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(<span class="at">numFmt =</span> <span class="st">"0"</span>)          <span class="co"># Integer format</span></span>
<span id="cb3-960"><a href="#cb3-960" aria-hidden="true" tabindex="-1"></a>    digits3_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(<span class="at">numFmt =</span> <span class="st">"0.000"</span>)      <span class="co"># Decimal with 3 digits</span></span>
<span id="cb3-961"><a href="#cb3-961" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-962"><a href="#cb3-962" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply percentage format</span></span>
<span id="cb3-963"><a href="#cb3-963" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(pct_rows) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-964"><a href="#cb3-964" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addStyle</span>(</span>
<span id="cb3-965"><a href="#cb3-965" aria-hidden="true" tabindex="-1"></a>        wb,</span>
<span id="cb3-966"><a href="#cb3-966" aria-hidden="true" tabindex="-1"></a>        <span class="at">sheet =</span> sheet_name,</span>
<span id="cb3-967"><a href="#cb3-967" aria-hidden="true" tabindex="-1"></a>        <span class="at">style =</span> pct_style,</span>
<span id="cb3-968"><a href="#cb3-968" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> pct_rows,</span>
<span id="cb3-969"><a href="#cb3-969" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="dv">4</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table),  <span class="co"># Apply to numeric columns</span></span>
<span id="cb3-970"><a href="#cb3-970" aria-hidden="true" tabindex="-1"></a>        <span class="at">gridExpand =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-971"><a href="#cb3-971" aria-hidden="true" tabindex="-1"></a>        <span class="at">stack =</span> <span class="cn">TRUE</span></span>
<span id="cb3-972"><a href="#cb3-972" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-973"><a href="#cb3-973" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-974"><a href="#cb3-974" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-975"><a href="#cb3-975" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply integer format</span></span>
<span id="cb3-976"><a href="#cb3-976" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(integer_rows) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-977"><a href="#cb3-977" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addStyle</span>(</span>
<span id="cb3-978"><a href="#cb3-978" aria-hidden="true" tabindex="-1"></a>        wb,</span>
<span id="cb3-979"><a href="#cb3-979" aria-hidden="true" tabindex="-1"></a>        <span class="at">sheet =</span> sheet_name,</span>
<span id="cb3-980"><a href="#cb3-980" aria-hidden="true" tabindex="-1"></a>        <span class="at">style =</span> integer_style,</span>
<span id="cb3-981"><a href="#cb3-981" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> integer_rows,</span>
<span id="cb3-982"><a href="#cb3-982" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="dv">4</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table),  <span class="co"># Apply to numeric columns</span></span>
<span id="cb3-983"><a href="#cb3-983" aria-hidden="true" tabindex="-1"></a>        <span class="at">gridExpand =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-984"><a href="#cb3-984" aria-hidden="true" tabindex="-1"></a>        <span class="at">stack =</span> <span class="cn">TRUE</span></span>
<span id="cb3-985"><a href="#cb3-985" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-986"><a href="#cb3-986" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-987"><a href="#cb3-987" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-988"><a href="#cb3-988" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply 3-decimal format</span></span>
<span id="cb3-989"><a href="#cb3-989" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(digits3_rows) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-990"><a href="#cb3-990" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addStyle</span>(</span>
<span id="cb3-991"><a href="#cb3-991" aria-hidden="true" tabindex="-1"></a>        wb,</span>
<span id="cb3-992"><a href="#cb3-992" aria-hidden="true" tabindex="-1"></a>        <span class="at">sheet =</span> sheet_name,</span>
<span id="cb3-993"><a href="#cb3-993" aria-hidden="true" tabindex="-1"></a>        <span class="at">style =</span> digits3_style,</span>
<span id="cb3-994"><a href="#cb3-994" aria-hidden="true" tabindex="-1"></a>        <span class="at">rows =</span> digits3_rows,</span>
<span id="cb3-995"><a href="#cb3-995" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> <span class="dv">4</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table),  <span class="co"># Apply to numeric columns</span></span>
<span id="cb3-996"><a href="#cb3-996" aria-hidden="true" tabindex="-1"></a>        <span class="at">gridExpand =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-997"><a href="#cb3-997" aria-hidden="true" tabindex="-1"></a>        <span class="at">stack =</span> <span class="cn">TRUE</span></span>
<span id="cb3-998"><a href="#cb3-998" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-999"><a href="#cb3-999" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-1000"><a href="#cb3-1000" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1001"><a href="#cb3-1001" aria-hidden="true" tabindex="-1"></a>    loss_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(summary_table<span class="sc">$</span>Variable <span class="sc">==</span> <span class="st">'Loss Ratio'</span>)</span>
<span id="cb3-1002"><a href="#cb3-1002" aria-hidden="true" tabindex="-1"></a>    premium_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(summary_table<span class="sc">$</span>Variable <span class="sc">==</span> <span class="st">'Mean price'</span>)</span>
<span id="cb3-1003"><a href="#cb3-1003" aria-hidden="true" tabindex="-1"></a>    proxy_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(summary_table<span class="sc">$</span>Variable <span class="sc">==</span> <span class="st">'Mean of proxy_vuln'</span>)</span>
<span id="cb3-1004"><a href="#cb3-1004" aria-hidden="true" tabindex="-1"></a>    cload_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(summary_table<span class="sc">$</span>Variable <span class="sc">==</span> <span class="st">'Mean of comm. loading'</span>)</span>
<span id="cb3-1005"><a href="#cb3-1005" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1006"><a href="#cb3-1006" aria-hidden="true" tabindex="-1"></a>    matched_rows <span class="ot">&lt;-</span> <span class="fu">c</span>(loss_rows, premium_rows, proxy_rows, cload_rows) <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb3-1007"><a href="#cb3-1007" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1008"><a href="#cb3-1008" aria-hidden="true" tabindex="-1"></a>    cols <span class="ot">&lt;-</span> <span class="dv">5</span><span class="sc">:</span>(<span class="fu">ncol</span>(summary_table) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb3-1009"><a href="#cb3-1009" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1010"><a href="#cb3-1010" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply conditional formatting for each matched row</span></span>
<span id="cb3-1011"><a href="#cb3-1011" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (row <span class="cf">in</span> matched_rows) {</span>
<span id="cb3-1012"><a href="#cb3-1012" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-1013"><a href="#cb3-1013" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Verify that cols and rows are numeric and valid</span></span>
<span id="cb3-1014"><a href="#cb3-1014" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.numeric</span>(cols) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.numeric</span>(row)) {</span>
<span id="cb3-1015"><a href="#cb3-1015" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"Columns and rows must be numeric."</span>)</span>
<span id="cb3-1016"><a href="#cb3-1016" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-1017"><a href="#cb3-1017" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-1018"><a href="#cb3-1018" aria-hidden="true" tabindex="-1"></a>      <span class="fu">conditionalFormatting</span>(</span>
<span id="cb3-1019"><a href="#cb3-1019" aria-hidden="true" tabindex="-1"></a>        wb,</span>
<span id="cb3-1020"><a href="#cb3-1020" aria-hidden="true" tabindex="-1"></a>        <span class="at">sheet =</span> sheet_name,</span>
<span id="cb3-1021"><a href="#cb3-1021" aria-hidden="true" tabindex="-1"></a>        <span class="at">cols =</span> cols, <span class="at">rows =</span> row,</span>
<span id="cb3-1022"><a href="#cb3-1022" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="st">'colourScale'</span>,</span>
<span id="cb3-1023"><a href="#cb3-1023" aria-hidden="true" tabindex="-1"></a>        <span class="at">style =</span> <span class="fu">c</span>(<span class="st">"#91CF60"</span>, <span class="st">"#FFFFBF"</span>, <span class="st">"#FC8D59"</span>)</span>
<span id="cb3-1024"><a href="#cb3-1024" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb3-1025"><a href="#cb3-1025" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-1026"><a href="#cb3-1026" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1027"><a href="#cb3-1027" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Auto-adjust column widths and set a smaller width for the first column</span></span>
<span id="cb3-1028"><a href="#cb3-1028" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setColWidths</span>(wb, sheet_name, <span class="at">cols =</span> <span class="dv">1</span>, <span class="at">widths =</span> <span class="dv">5</span>)  <span class="co"># Smaller width for the Section column</span></span>
<span id="cb3-1029"><a href="#cb3-1029" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setColWidths</span>(wb, sheet_name, <span class="at">cols =</span> <span class="dv">2</span>, <span class="at">widths =</span> <span class="dv">15</span>)  <span class="co"># Smaller width for the Section column</span></span>
<span id="cb3-1030"><a href="#cb3-1030" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setColWidths</span>(wb, sheet_name, <span class="at">cols =</span> <span class="dv">3</span>, <span class="at">widths =</span> <span class="dv">8</span>)  <span class="co"># Smaller width for the Section column</span></span>
<span id="cb3-1031"><a href="#cb3-1031" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setColWidths</span>(wb, sheet_name, <span class="at">cols =</span> <span class="dv">4</span><span class="sc">:</span><span class="fu">ncol</span>(summary_table), <span class="at">widths =</span> <span class="dv">8</span>)</span>
<span id="cb3-1032"><a href="#cb3-1032" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1033"><a href="#cb3-1033" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1034"><a href="#cb3-1034" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Add custom content </span></span>
<span id="cb3-1035"><a href="#cb3-1035" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the custom row directly to the sheet</span></span>
<span id="cb3-1036"><a href="#cb3-1036" aria-hidden="true" tabindex="-1"></a>    start_row <span class="ot">&lt;-</span> <span class="fu">nrow</span>(summary_table) <span class="sc">+</span> <span class="dv">3</span></span>
<span id="cb3-1037"><a href="#cb3-1037" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeData</span>(wb, sheet_name, <span class="fu">t</span>(to_add <span class="sc">%&gt;%</span> unname),</span>
<span id="cb3-1038"><a href="#cb3-1038" aria-hidden="true" tabindex="-1"></a>              <span class="at">startRow =</span> start_row,</span>
<span id="cb3-1039"><a href="#cb3-1039" aria-hidden="true" tabindex="-1"></a>              <span class="at">startCol =</span> <span class="dv">1</span>, <span class="at">colNames =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-1040"><a href="#cb3-1040" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1041"><a href="#cb3-1041" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a style for the custom row</span></span>
<span id="cb3-1042"><a href="#cb3-1042" aria-hidden="true" tabindex="-1"></a>    custom_style <span class="ot">&lt;-</span> <span class="fu">createStyle</span>(</span>
<span id="cb3-1043"><a href="#cb3-1043" aria-hidden="true" tabindex="-1"></a>      <span class="at">fgFill =</span> <span class="st">"grey90"</span>,     <span class="co"># Light grey background</span></span>
<span id="cb3-1044"><a href="#cb3-1044" aria-hidden="true" tabindex="-1"></a>      <span class="at">fontColour =</span> <span class="st">"grey50"</span>, <span class="co"># Dark grey text</span></span>
<span id="cb3-1045"><a href="#cb3-1045" aria-hidden="true" tabindex="-1"></a>      <span class="at">wrapText =</span> <span class="cn">TRUE</span>,       <span class="co"># Enable text wrapping</span></span>
<span id="cb3-1046"><a href="#cb3-1046" aria-hidden="true" tabindex="-1"></a>      <span class="at">valign =</span> <span class="st">"TOP"</span>,      <span class="co"># Center vertical alignment,</span></span>
<span id="cb3-1047"><a href="#cb3-1047" aria-hidden="true" tabindex="-1"></a>      <span class="at">halign =</span> <span class="st">'LEFT'</span>,</span>
<span id="cb3-1048"><a href="#cb3-1048" aria-hidden="true" tabindex="-1"></a>      <span class="at">textDecoration =</span> <span class="st">"Bold"</span></span>
<span id="cb3-1049"><a href="#cb3-1049" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-1050"><a href="#cb3-1050" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1051"><a href="#cb3-1051" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the style to the custom row</span></span>
<span id="cb3-1052"><a href="#cb3-1052" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addStyle</span>(</span>
<span id="cb3-1053"><a href="#cb3-1053" aria-hidden="true" tabindex="-1"></a>      wb, <span class="at">sheet =</span> sheet_name, <span class="at">style =</span> custom_style,</span>
<span id="cb3-1054"><a href="#cb3-1054" aria-hidden="true" tabindex="-1"></a>      <span class="at">rows =</span> start_row, <span class="at">cols =</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(to_add)),</span>
<span id="cb3-1055"><a href="#cb3-1055" aria-hidden="true" tabindex="-1"></a>      <span class="at">gridExpand =</span> <span class="cn">TRUE</span>, <span class="at">stack =</span> <span class="cn">TRUE</span></span>
<span id="cb3-1056"><a href="#cb3-1056" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-1057"><a href="#cb3-1057" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1058"><a href="#cb3-1058" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust the row height for the new row (taller row for long text)</span></span>
<span id="cb3-1059"><a href="#cb3-1059" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setRowHeights</span>(wb, sheet_name, <span class="at">rows =</span> start_row, <span class="at">heights =</span> <span class="dv">60</span>)</span>
<span id="cb3-1060"><a href="#cb3-1060" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1061"><a href="#cb3-1061" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-1062"><a href="#cb3-1062" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Freeze the first 3 columns and the first 2 rows</span></span>
<span id="cb3-1063"><a href="#cb3-1063" aria-hidden="true" tabindex="-1"></a>    <span class="fu">freezePane</span>(wb, sheet_name, <span class="at">firstActiveRow =</span> <span class="dv">5</span>, <span class="at">firstActiveCol =</span> <span class="dv">4</span>)</span>
<span id="cb3-1064"><a href="#cb3-1064" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-1065"><a href="#cb3-1065" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-1066"><a href="#cb3-1066" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the workbook to a file</span></span>
<span id="cb3-1067"><a href="#cb3-1067" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveWorkbook</span>(wb, file_name, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-1068"><a href="#cb3-1068" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Summary table successfully exported to: "</span>, file_name)</span>
<span id="cb3-1069"><a href="#cb3-1069" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-1070"><a href="#cb3-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1071"><a href="#cb3-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1072"><a href="#cb3-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb3-1073"><a href="#cb3-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1074"><a href="#cb3-1074" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a gradient of 5 colors between two given colors</span></span>
<span id="cb3-1075"><a href="#cb3-1075" aria-hidden="true" tabindex="-1"></a>generate_gradient <span class="ot">&lt;-</span> <span class="cf">function</span>(start_color, end_color, <span class="at">n =</span> <span class="dv">5</span>) {</span>
<span id="cb3-1076"><a href="#cb3-1076" aria-hidden="true" tabindex="-1"></a>  scales<span class="sc">::</span><span class="fu">gradient_n_pal</span>(<span class="fu">c</span>(start_color, end_color))(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> n))</span>
<span id="cb3-1077"><a href="#cb3-1077" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-1078"><a href="#cb3-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1079"><a href="#cb3-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-1080"><a href="#cb3-1080" aria-hidden="true" tabindex="-1"></a>recode_bottom_top_middle <span class="ot">&lt;-</span> <span class="cf">function</span>(levels, <span class="at">numeric =</span> <span class="cn">FALSE</span>, <span class="at">n_bottom =</span> <span class="dv">3</span>, <span class="at">n_top =</span> <span class="dv">3</span>, <span class="at">factor_values =</span> <span class="cn">NULL</span>) {</span>
<span id="cb3-1081"><a href="#cb3-1081" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if input is valid</span></span>
<span id="cb3-1082"><a href="#cb3-1082" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(levels) <span class="sc">||</span> <span class="fu">length</span>(levels) <span class="sc">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb3-1083"><a href="#cb3-1083" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Input levels must be a non-empty numeric vector."</span>)</span>
<span id="cb3-1084"><a href="#cb3-1084" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-1085"><a href="#cb3-1085" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-1086"><a href="#cb3-1086" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure levels are numeric</span></span>
<span id="cb3-1087"><a href="#cb3-1087" aria-hidden="true" tabindex="-1"></a>  levels <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(levels)</span>
<span id="cb3-1088"><a href="#cb3-1088" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-1089"><a href="#cb3-1089" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If numeric = TRUE, factor_values must be provided</span></span>
<span id="cb3-1090"><a href="#cb3-1090" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (numeric <span class="sc">&amp;&amp;</span> (<span class="fu">is.null</span>(factor_values) <span class="sc">||</span> <span class="fu">length</span>(factor_values) <span class="sc">&lt;</span> <span class="dv">1</span>)) {</span>
<span id="cb3-1091"><a href="#cb3-1091" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"For numeric = TRUE, a valid 'factor_values' vector must be provided."</span>)</span>
<span id="cb3-1092"><a href="#cb3-1092" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-1093"><a href="#cb3-1093" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-1094"><a href="#cb3-1094" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle cases where the total number of levels is insufficient for grouping</span></span>
<span id="cb3-1095"><a href="#cb3-1095" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(levels) <span class="sc">&lt;=</span> (n_bottom <span class="sc">+</span> n_top <span class="sc">+</span> <span class="dv">1</span>)) {</span>
<span id="cb3-1096"><a href="#cb3-1096" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">factor</span>(levels, <span class="at">levels =</span> <span class="fu">as.character</span>(levels))) <span class="co"># No middle group possible</span></span>
<span id="cb3-1097"><a href="#cb3-1097" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-1098"><a href="#cb3-1098" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-1099"><a href="#cb3-1099" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the bottom and top ranges dynamically based on the original order</span></span>
<span id="cb3-1100"><a href="#cb3-1100" aria-hidden="true" tabindex="-1"></a>  bottom <span class="ot">&lt;-</span> levels[<span class="dv">1</span><span class="sc">:</span>n_bottom]  <span class="co"># First `n_bottom` values</span></span>
<span id="cb3-1101"><a href="#cb3-1101" aria-hidden="true" tabindex="-1"></a>  top <span class="ot">&lt;-</span> levels[(<span class="fu">length</span>(levels) <span class="sc">-</span> n_top <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span><span class="fu">length</span>(levels)]  <span class="co"># Last `n_top` values</span></span>
<span id="cb3-1102"><a href="#cb3-1102" aria-hidden="true" tabindex="-1"></a>  middle <span class="ot">&lt;-</span> levels[<span class="sc">!</span>(levels <span class="sc">%in%</span> <span class="fu">c</span>(bottom, top))]  <span class="co"># Remaining middle</span></span>
<span id="cb3-1103"><a href="#cb3-1103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-1104"><a href="#cb3-1104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dynamically create label for the middle group</span></span>
<span id="cb3-1105"><a href="#cb3-1105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(middle) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb3-1106"><a href="#cb3-1106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (numeric) {</span>
<span id="cb3-1107"><a href="#cb3-1107" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Subset the factor_values for rows where the levels belong to the middle group</span></span>
<span id="cb3-1108"><a href="#cb3-1108" aria-hidden="true" tabindex="-1"></a>      middle_values <span class="ot">&lt;-</span> factor_values[factor_values <span class="sc">%in%</span> middle]</span>
<span id="cb3-1109"><a href="#cb3-1109" aria-hidden="true" tabindex="-1"></a>      middle_mean <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">mean</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(middle_values)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">3</span>) <span class="co"># Compute mean</span></span>
<span id="cb3-1110"><a href="#cb3-1110" aria-hidden="true" tabindex="-1"></a>      middle_label <span class="ot">&lt;-</span> middle_mean</span>
<span id="cb3-1111"><a href="#cb3-1111" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-1112"><a href="#cb3-1112" aria-hidden="true" tabindex="-1"></a>      middle_label <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">min</span>(middle), <span class="st">"-"</span>, <span class="fu">max</span>(middle)) <span class="co"># Range as label</span></span>
<span id="cb3-1113"><a href="#cb3-1113" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-1114"><a href="#cb3-1114" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">length</span>(middle) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb3-1115"><a href="#cb3-1115" aria-hidden="true" tabindex="-1"></a>    middle_label <span class="ot">&lt;-</span> <span class="fu">as.character</span>(middle)  <span class="co"># Single value retains its original label</span></span>
<span id="cb3-1116"><a href="#cb3-1116" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-1117"><a href="#cb3-1117" aria-hidden="true" tabindex="-1"></a>    middle_label <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-1118"><a href="#cb3-1118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-1119"><a href="#cb3-1119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-1120"><a href="#cb3-1120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a mapping for novel levels</span></span>
<span id="cb3-1121"><a href="#cb3-1121" aria-hidden="true" tabindex="-1"></a>  recoded <span class="ot">&lt;-</span> <span class="fu">sapply</span>(levels, <span class="cf">function</span>(x) {</span>
<span id="cb3-1122"><a href="#cb3-1122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x <span class="sc">%in%</span> bottom) <span class="fu">return</span>(<span class="fu">as.character</span>(x))       <span class="co"># Keep bottom levels as is</span></span>
<span id="cb3-1123"><a href="#cb3-1123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x <span class="sc">%in%</span> middle) <span class="fu">return</span>(<span class="fu">as.character</span>(middle_label)) <span class="co"># Group middle levels dynamically</span></span>
<span id="cb3-1124"><a href="#cb3-1124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x <span class="sc">%in%</span> top) <span class="fu">return</span>(<span class="fu">as.character</span>(x))          <span class="co"># Keep top levels as is</span></span>
<span id="cb3-1125"><a href="#cb3-1125" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-1126"><a href="#cb3-1126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-1127"><a href="#cb3-1127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return as a factor with ordered levels maintaining the original order</span></span>
<span id="cb3-1128"><a href="#cb3-1128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">factor</span>(recoded, <span class="at">levels =</span> <span class="fu">unique</span>(recoded), <span class="at">ordered =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-1129"><a href="#cb3-1129" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code to export the summary tables</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">'tables'</span>)) <span class="fu">dir.create</span>(<span class="st">'tables'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario <span class="cf">in</span> <span class="fu">names</span>(group_pop_stats)) {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> group_pop_stats[[scenario]]<span class="sc">$</span>valid</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract dictionaries</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  dictionnary_proxy <span class="ot">&lt;-</span> dictionnary_leaves_trees<span class="sc">$</span>proxy_vuln[[scenario]]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  dictionnary_comm <span class="ot">&lt;-</span> dictionnary_leaves_trees<span class="sc">$</span>comm_load[[scenario]]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">export_to_excel</span>(<span class="at">summary_tables =</span> <span class="fu">summarize_fairness_groups</span>(</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">D =</span> <span class="fu">factor</span>(D), <span class="at">X2 =</span> <span class="fu">factor</span>(X2)),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">marg_dist =</span> marg_dist[[scenario]],</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">sensitive_variable =</span> <span class="st">"D"</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">dictionnary_proxy =</span> dictionnary_proxy,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">dictionnary_comm =</span> dictionnary_comm),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">file_name =</span> <span class="fu">paste0</span>(<span class="st">'../docs/tables/summaries_'</span>, scenario, <span class="st">'.xlsx'</span>))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="download-disparity-tables" class="level2 page-columns page-full" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="download-disparity-tables"><span class="header-section-number">6.1</span> Download Disparity Tables</h2>

<div class="no-row-height column-margin column-container"><div class="">
<div class="related-box">
<p><strong>Related section</strong><br>
The comprehensive monitoring table of the case study is illustrated in <strong>Figure 14 of the main paper.</strong></p>
</div>
</div></div><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can download the Excel disparity tables for each scenario below.</p>
</div>
</div>
<div class="d-flex flex-wrap gap-3">
<p><a href="tables/summaries_Scenario1.xlsx" class="btn btn-outline-primary" role="button" download=""> â¬‡ Scenario 1 </a></p>
<p><a href="tables/summaries_Scenario2.xlsx" class="btn btn-outline-secondary" role="button" download=""> â¬‡ Scenario 2 </a></p>
<p><a href="tables/summaries_Scenario3.xlsx" class="btn btn-outline-warning" role="button" download=""> â¬‡ Scenario 3 </a></p>
</div>
<div id="fig-bigchart" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-bigchart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.1: Summary of the methodology of the paper
</figcaption>
<div aria-describedby="fig-bigchart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figs/flowchart_estimating_spectrum.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;6.1: Summary of the methodology of the paper"><img src="figs/flowchart_estimating_spectrum.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
</figure>
</div>


</section>

</main> <!-- /main -->
<div class="site-history">

  <div class="history-title">

    <span class="gh-mark" aria-hidden="true">

      <svg viewbox="0 0 16 16" width="14" height="14">

        <path fill="currentColor" fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38

             0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13

             -.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66

             .07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15

             -.08-.2-.36-1.01.08-2.11 0 0 .67-.21 2.2.82.63-.18 1.31-.27 2-.27.69 0 1.37.09 2 .27

             1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.91.08 2.11.51.56.82 1.27.82 2.15

             0 3.06-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2

             0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"></path>

      </svg>

    </span>

    History

  </div>

  <div id="commit-history">Loadingâ€¦</div>

</div>



<script src="extras/commit-history.js"></script>

<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./5_partitioning.html" class="pagination-link" aria-label="Partitioning">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Partitioning</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./9_references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize || "1.2em",
          commentDelimiter: el.dataset.commentDelimiter || "//",
          lineNumber: el.dataset.lineNumber === "true" ? true : false,
          lineNumberPunc: el.dataset.lineNumberPunc || ":",
          noEnd: el.dataset.noEnd === "true" ? true : false,
          titlePrefix: el.dataset.captionPrefix || "Algorithm"
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>